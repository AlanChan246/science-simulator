<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elastic Racer: Hooke's Law Grand Prix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap');

        body { 
            margin: 0; overflow: hidden; background-color: #0b0c15; 
            font-family: 'Noto Sans TC', sans-serif; color: white; 
            user-select: none; -webkit-user-select: none; 
            /* Prevent browser gestures (zoom/scroll) globally */
            touch-action: none; 
        }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* --- SETUP SIDEBAR --- */
        #garage {
            position: absolute; top: 0; left: 0; bottom: 0; width: 420px;
            background: rgba(15, 20, 35, 0.95);
            border-right: 1px solid rgba(0, 210, 255, 0.3);
            display: flex; flex-direction: column; padding: 25px;
            box-sizing: border-box; pointer-events: auto;
            transform: translateX(0); transition: transform 0.5s ease;
            overflow-y: auto; z-index: 100;
            
            /* CRITICAL FIX: Re-enable scrolling inside the garage menu on mobile */
            touch-action: pan-y; 
        }
        #garage.hidden { transform: translateX(-100%); }

        /* Vehicle Preview */

        h1 { font-family: 'Orbitron'; font-size: 1.8rem; margin: 0 0 0.5rem 0; color: #fff; text-shadow: 0 0 10px #00d2ff; }
        p.subtitle { color: #8899aa; margin-bottom: 1.5rem; font-size: 0.9rem; }

        .control-group { margin-bottom: 1.2rem; position: relative; }
        label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; color: #ccddee; font-weight: bold; font-size: 0.9rem; }
        
        /* Tooltip Style */
        .info-icon {
            background: rgba(0, 210, 255, 0.2); color: #00d2ff; border-radius: 50%;
            width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: help; margin-left: 8px; border: 1px solid #00d2ff;
        }
        .tooltip {
            display: none; position: absolute; left: 0; bottom: 100%; width: 100%;
            background: #111; border: 1px solid #333; padding: 10px; border-radius: 5px;
            font-size: 0.85rem; color: #ddd; z-index: 200; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            line-height: 1.4; margin-bottom: 5px;
        }
        .control-group:hover .tooltip,
        .control-group.active .tooltip { display: block; }

        select, input[type="range"] { 
            width: 100%; background: rgba(0,0,0,0.3); color: #00d2ff; 
            border: 1px solid #334455; padding: 8px; border-radius: 4px; 
            font-family: 'Noto Sans TC';
            font-size: 16px; /* Prevents auto-zoom on iOS */
        }
        
        button.action-btn {
            width: 100%; padding: 20px; margin-top: 15px; /* Larger touch target */
            background: linear-gradient(135deg, #00d2ff, #007bff);
            border: none; color: white; font-family: 'Noto Sans TC'; font-weight: bold; font-size: 1.2rem;
            cursor: pointer; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,123,255,0.4);
            touch-action: manipulation;
        }

        /* --- HUD ELEMENTS --- */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: none;
        }

        /* MAP (Bottom Left) */
        #mini-map {
            position: absolute; bottom: 20px; left: 20px;
            width: 280px; background: rgba(0,0,0,0.7); 
            padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);
        }
        .racer-row { margin-bottom: 6px; }
        .racer-label { font-size: 0.75rem; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .progress-track { height: 5px; background: #333; border-radius: 3px; position: relative; }
        .progress-bar { height: 100%; width: 0%; border-radius: 3px; transition: width 0.1s linear; }

        /* SPEEDOMETER (Bottom Right) */
        #speedometer {
            position: absolute; bottom: 20px; right: 20px;
            text-align: right;
        }
        .speed-val { font-size: 3.5rem; font-family: 'Orbitron'; color: #fff; line-height: 1; text-shadow: 0 0 15px rgba(0,210,255,0.5); }
        .speed-unit { font-size: 0.9rem; color: #8899aa; letter-spacing: 2px; }

        /* TIMER (Top Right) */
        #timer {
            position: absolute; top: 20px; right: 20px;
            text-align: right; pointer-events: none;
        }
        .timer-val { font-size: 2rem; font-family: 'Orbitron'; color: #fff; line-height: 1; text-shadow: 0 0 10px rgba(0,210,255,0.5); }
        .timer-label { font-size: 0.8rem; color: #8899aa; letter-spacing: 1px; }

        /* PAUSE BUTTON */
        #pause-btn {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 12px 20px; border-radius: 8px;
            cursor: pointer; font-family: 'Noto Sans TC'; font-size: 1rem;
            pointer-events: auto; z-index: 100;
            transition: all 0.2s;
        }
        #pause-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* PAUSE MENU */
        #pause-menu {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 400; align-items: center; justify-content: center;
            pointer-events: auto; touch-action: auto;
        }
        .pause-menu-card {
            background: rgba(15, 20, 35, 0.98); border: 2px solid rgba(0,210,255,0.5);
            border-radius: 15px; padding: 40px; max-width: 400px; width: 90%;
            box-shadow: 0 0 50px rgba(0,210,255,0.3); text-align: center;
        }
        .pause-menu-title {
            font-family: 'Orbitron'; color: #00d2ff; font-size: 2rem; margin-bottom: 30px;
        }
        .pause-menu-btn {
            width: 100%; padding: 15px; margin: 10px 0;
            background: linear-gradient(135deg, #00d2ff, #007bff);
            border: none; color: white; font-family: 'Noto Sans TC';
            font-weight: bold; font-size: 1.1rem; cursor: pointer;
            border-radius: 8px; pointer-events: auto;
            transition: all 0.2s;
        }
        .pause-menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,123,255,0.4);
        }
        .pause-menu-btn.secondary {
            background: rgba(255,255,255,0.1);
        }

        /* COUNTDOWN */
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Orbitron'; font-size: 8rem; color: #fff;
            text-shadow: 0 0 40px #00d2ff; display: none; z-index: 150;
        }

        /* TENSION */
        #tension-ui {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            display: none; text-align: center; pointer-events: none;
        }
        .tension-val { font-size: 2.5rem; font-family: 'Orbitron'; color: #ff4444; text-shadow: 0 2px 10px black; }
        .pull-hint { color: rgba(255,255,255,0.9); font-size: 1rem; margin-top: 5px; font-weight: bold; text-shadow: 0 2px 4px black; }

        /* END SCREEN */
        #end-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(11, 12, 21, 0.98), rgba(20, 25, 40, 0.98)); 
            align-items: center; justify-content: center;
            pointer-events: auto; z-index: 200;
            touch-action: auto;
            flex-direction: column; padding: 30px 20px; box-sizing: border-box;
            overflow-y: auto;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .end-screen-title {
            font-family: 'Orbitron'; 
            font-size: 3rem; 
            margin-bottom: 10px; 
            width: 100%; 
            text-align: center;
            color: #00d2ff;
            text-shadow: 0 0 20px rgba(0,210,255,0.5);
            animation: slideUp 0.6s ease-out;
        }
        .end-screen-subtitle {
            text-align: center;
            color: #8899aa;
            font-size: 1.1rem;
            margin-bottom: 30px;
            animation: slideUp 0.7s ease-out;
        }
        .end-screen-content {
            display: flex;
            flex-direction: row;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            justify-content: center;
            align-items: flex-start;
            animation: slideUp 0.8s ease-out;
        }
        .rank-card, .leaderboard-card {
            background: rgba(255,255,255,0.08); 
            padding: 2rem; 
            border-radius: 15px; 
            width: 100%;
            max-width: 400px;
            border: 2px solid rgba(0,210,255,0.3); 
            box-shadow: 0 0 30px rgba(0,210,255,0.2), inset 0 0 20px rgba(0,210,255,0.05);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .rank-card:hover, .leaderboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 40px rgba(0,210,255,0.3), inset 0 0 20px rgba(0,210,255,0.1);
        }
        .rank-card h3, .leaderboard-card h3 {
            font-family: 'Orbitron'; 
            color: #00d2ff; 
            margin: 0 0 20px 0; 
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(0,210,255,0.5);
            border-bottom: 2px solid rgba(0,210,255,0.3);
            padding-bottom: 10px;
        }
        .rank-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 15px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            color: white; 
            font-size: 1.1rem;
            transition: background 0.2s ease;
        }
        .rank-row:hover {
            background: rgba(0,210,255,0.1);
            border-radius: 5px;
            padding-left: 10px;
            padding-right: 10px;
        }
        .rank-place { 
            color: #00d2ff; 
            font-family: 'Orbitron'; 
            font-weight: bold; 
            width: 50px;
            font-size: 1.3rem;
            text-shadow: 0 0 10px rgba(0,210,255,0.5);
        }
        .rank-name {
            flex: 1;
            margin-left: 15px;
        }
        .rank-medal {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        .leaderboard-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            color: white; 
            font-size: 0.95rem;
            transition: background 0.2s ease;
        }
        .leaderboard-row:hover {
            background: rgba(255,204,0,0.1);
            border-radius: 5px;
            padding-left: 10px;
            padding-right: 10px;
        }
        .leaderboard-rank {
            color: #8899aa;
            font-family: 'Orbitron';
            width: 30px;
            font-size: 0.9rem;
        }
        .leaderboard-name {
            flex: 1;
            margin-left: 10px;
        }
        .leaderboard-time { 
            color: #ffcc00; 
            font-family: 'Orbitron'; 
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255,204,0,0.5);
        }
        .player-result-card {
            background: linear-gradient(135deg, rgba(0,210,255,0.15), rgba(0,150,255,0.1));
            border: 2px solid rgba(0,210,255,0.5);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .player-result-time {
            font-family: 'Orbitron';
            font-size: 2rem;
            color: #00d2ff;
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(0,210,255,0.8);
        }
        .player-result-rank {
            font-size: 1.2rem;
            color: #ffcc00;
            margin-top: 5px;
        }
        .end-screen-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            width: 100%;
            animation: slideUp 0.9s ease-out;
        }
        
        @media (max-width: 1000px) {
            .end-screen-content { 
                flex-direction: column; 
                align-items: center;
            }
            .rank-card, .leaderboard-card { 
                width: 100%; 
                max-width: 500px;
            }
            .end-screen-title {
                font-size: 2rem;
            }
        }

        @media (max-width: 600px) {
            #garage { 
                width: 100%; 
                height: 75%; /* Covers bottom 75% */
                top: auto; 
                bottom: 0; 
                border-right: none; 
                border-top: 1px solid rgba(0,210,255,0.3); 
            }
            #mini-map { 
                width: 180px; left: 10px; bottom: 10px; padding: 10px; 
            }
            .speed-val { font-size: 2.5rem; }
            #speedometer { right: 10px; bottom: 10px; }
            /* Make sure inputs are easy to tap */
            input[type=range] { padding: 10px 0; }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <!-- Main Menu -->
        <div id="main-menu" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11, 12, 21, 0.98); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 250; pointer-events: auto;">
            <h1 style="font-family: 'Orbitron'; font-size: 3rem; color: #00d2ff; margin-bottom: 10px; text-shadow: 0 0 20px #00d2ff;">å½ˆåŠ›è³½è»Šæ‰‹</h1>
            <p style="color: #8899aa; font-size: 1.2rem; margin-bottom: 50px;">Hooke's Law Grand Prix</p>
            <div style="display: flex; flex-direction: column; gap: 20px; width: 300px;">
                <button class="action-btn" id="create-vehicle-btn" style="padding: 20px; font-size: 1.3rem;">å‰µå»ºæ–°è»Šè¼›</button>
                <button class="action-btn" id="select-vehicle-btn" style="padding: 20px; font-size: 1.3rem; background: linear-gradient(135deg, #ff6b6b, #ee5a6f);">é¸æ“‡å·²æœ‰è»Šè¼›</button>
            </div>
        </div>

        <!-- Create Vehicle Name Modal -->
        <div id="create-name-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; touch-action: auto; pointer-events: auto;" onclick="if(event.target.id === 'create-name-modal') { closeCreateNameModal(); }">
            <div style="background: rgba(15, 20, 35, 0.98); border: 2px solid rgba(0,210,255,0.5); border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 0 50px rgba(0,210,255,0.3); position: relative; pointer-events: auto;" onclick="event.stopPropagation();">
                <h2 style="font-family: 'Orbitron'; color: #00d2ff; margin: 0 0 20px 0;">å‰µå»ºæ–°è»Šè¼›</h2>
                <p style="color: #ddd; margin-bottom: 10px;">è«‹è¼¸å…¥ç­åˆ¥å­¸è™Ÿï¼š</p>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px; line-height: 1.5;">ä¾‹å¦‚ï¼š1Aï¼ˆ01ï¼‰<br>æ ¼å¼ï¼šç­åˆ¥ï¼ˆå­¸è™Ÿï¼‰</p>
                <input type="text" id="create-vehicle-name-input" placeholder="ä¾‹å¦‚ï¼š1Aï¼ˆ01ï¼‰" maxlength="20" autofocus style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #334455; border-radius: 5px; color: white; font-size: 1rem; margin-bottom: 20px; font-family: 'Noto Sans TC'; pointer-events: auto; box-sizing: border-box;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="action-btn" id="cancel-create-btn" style="padding: 12px; font-size: 1rem; background: rgba(255,255,255,0.1); pointer-events: auto; cursor: pointer;" type="button">å–æ¶ˆ</button>
                    <button class="action-btn" id="confirm-create-btn" style="padding: 12px; font-size: 1rem; pointer-events: auto; cursor: pointer;" type="button">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <!-- Setup Garage -->
        <div id="garage" style="display: none;">
            <h1 id="garage-title">å½ˆåŠ›è³½è»Šæ‰‹</h1>
            <p class="subtitle">Hooke's Law Grand Prix</p>
            
            <div class="control-group">
                <label>
                    <div>AI é›£åº¦ (Difficulty)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">èª¿æ•´å°æ‰‹çš„åæ‡‰é€Ÿåº¦å’ŒåŠ›é‡ã€‚ç°¡å–®æ¨¡å¼ä¸‹ï¼ŒAI æœƒç¶“å¸¸åœä¸‹ä¾†æ€è€ƒï¼Œä¸”æ‹‰å¼“å‹•ä½œç·©æ…¢ã€‚</div>
                <select id="ai-difficulty">
                    <option value="easy" selected>éå¸¸ç°¡å–® (Easy)</option>
                    <option value="medium">æ™®é€š (Normal)</option>
                    <option value="hard">å›°é›£ (Hard)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>
                    <div>æ©¡çš®ç­‹æè³ª (Material)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">æ±ºå®šææ–™çš„å½ˆæ€§ä¿‚æ•¸ (Young's Modulus)ã€‚</div>
                <select id="material-select">
                    <option value="0.5">é¬†è»Ÿçš„èˆŠé«®åœˆ (Soft)</option>
                    <option value="0.8">è¾¦å…¬å®¤æ©¡çš®ç­‹ (Normal)</option>
                    <option value="1.0">è¤‡åˆæ©¡è†  (Standard)</option>
                    <option value="1.5">è¤²é ­é¬†ç·Šå¸¶ (Strong)</option>
                    <option value="2.5">å·¥æ¥­ç”¨å½ˆåŠ›ç¹© (Very Stiff)</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <div>è¼ªèƒé¡å‹ (Tyres)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">å½±éŸ¿æ‘©æ“¦ä¿‚æ•¸ã€‚<br>å…‰é ­èƒæ»‘è¡Œè·é›¢æœ€é ï¼Œè¶Šé‡èƒç…è»Šæœ€å¿«ã€‚</div>
                <select id="wheel-select">
                    <option value="slick">å…‰é ­èƒ (ä½æ‘©æ“¦/æ»‘è¡Œé )</option>
                    <option value="standard" selected>æ¨™æº–èƒ (å¹³è¡¡)</option>
                    <option value="offroad">è¶Šé‡èƒ (é«˜æŠ“åœ°/æ¸›é€Ÿå¿«)</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <div>è¼ªå­æ•¸é‡ (Wheel Count)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">æ›´å¤šè¼ªå­ = æ›´å¤šæ‘©æ“¦åŠ› = æ›´ç©©å®šä½†åŠ é€Ÿè¼ƒæ…¢ã€‚<br>ç‰©ç†åŸç†ï¼šç¸½æ‘©æ“¦åŠ› = å–®è¼ªæ‘©æ“¦åŠ› Ã— è¼ªæ•¸</div>
                <input type="range" id="wheel-count-range" min="2" max="10" value="4" step="1">
                <div id="wheel-count-display" style="text-align: center; color: #00d2ff; margin-top: 5px; font-family: 'Orbitron';">4 å€‹è¼ªå­</div>
            </div>

            <div class="control-group">
                <label>
                    <div>è¼ªå­å¤§å° (Wheel Size)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">å¤§è¼ªå­ = æ›´é‡ = æ›´æ…¢åŠ é€Ÿï¼Œä½†æ»¾å‹•é˜»åŠ›å°ã€‚<br>ç‰©ç†åŸç†ï¼šè½‰å‹•æ…£é‡ I = 0.5 Ã— m Ã— rÂ²</div>
                <select id="wheel-size-select">
                    <option value="small">å°è¼ª (è¼•å¿«/æ»¾å‹•é˜»åŠ›å¤§)</option>
                    <option value="medium" selected>ä¸­è¼ª (å¹³è¡¡)</option>
                    <option value="large">å¤§è¼ª (é‡æ…¢/æ»¾å‹•é˜»åŠ›å°)</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <div>è»Šèº«é•·åº¦ (Body Length)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">é•·è»Šèº« = æ›´å¤šç©ºæ°£é˜»åŠ›ï¼Œä½†æ›´ç©©å®šã€‚<br>ç‰©ç†åŸç†ï¼šç©ºæ°£é˜»åŠ› F = 0.5 Ã— Ï Ã— A Ã— vÂ² Ã— Cd</div>
                <select id="body-length-select">
                    <option value="short">çŸ­è»Šèº« (ä½é¢¨é˜»/ä¸ç©©å®š)</option>
                    <option value="medium" selected>ä¸­è»Šèº« (å¹³è¡¡)</option>
                    <option value="long">é•·è»Šèº« (é«˜é¢¨é˜»/ç©©å®š)</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <div>è»Šèº«å¯¬åº¦ (Body Width)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">å¯¬è»Šèº« = æ›´å¤šé¢¨é˜»ï¼Œä½†å¯å®¹ç´æ›´å¤šè¼ªå­ã€‚</div>
                <select id="body-width-select">
                    <option value="narrow">çª„è»Šèº« (ä½é¢¨é˜»)</option>
                    <option value="medium" selected>ä¸­è»Šèº« (å¹³è¡¡)</option>
                    <option value="wide">å¯¬è»Šèº« (é«˜é¢¨é˜»)</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <div>è»Šé‡ (Vehicle Weight)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">é‡è»Š = æ›´æ…¢åŠ é€Ÿï¼Œä½†æ…£æ€§å¤§ï¼ˆæ»‘è¡Œé ï¼‰ã€‚<br>ç‰©ç†åŸç†ï¼šF = maï¼Œå‹•èƒ½ E = 0.5mvÂ²</div>
                <select id="body-weight-select">
                    <option value="light">è¼•è»Š (åŠ é€Ÿå¿«/æ…£æ€§å°)</option>
                    <option value="medium" selected>ä¸­è»Š (å¹³è¡¡)</option>
                    <option value="heavy">é‡è»Š (åŠ é€Ÿæ…¢/æ…£æ€§å¤§)</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <div>ç©ºæ°£å‹•åŠ› (Aero)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">å½±éŸ¿é¢¨é˜»ã€‚<br>æµç·šå‹è¨­è¨ˆåœ¨é«˜é€Ÿæ™‚æ¸›é€Ÿè¼ƒæ…¢ã€‚</div>
                <select id="aero-select">
                    <option value="streamlined">æµç·šå‹ (ä½é¢¨é˜»)</option>
                    <option value="stock" selected>åŸå»  (æ¨™æº–)</option>
                    <option value="bulky">é‡è£ç”² (é«˜é¢¨é˜»)</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <div>åšåº¦ (Thickness)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">å¢åŠ æˆªé¢ç© (A)ã€‚è¶Šç²—çš„æ©¡çš®ç­‹å‹åº¦ä¿‚æ•¸ (k) è¶Šé«˜ã€‚</div>
                <input type="range" id="thickness-range" min="1" max="10" value="5" step="0.5">
            </div>

            <div class="control-group">
                <label>
                    <div>é¬†å¼›é•·åº¦ (Slack Length)</div>
                    <div class="info-icon">?</div>
                </label>
                <div class="tooltip">æ©¡çš®ç­‹çš„åŸé•· (L)ã€‚è¶ŠçŸ­çš„æ©¡çš®ç­‹è¶Šç·Šç¹ƒï¼Œçˆ†ç™¼åŠ›è¶Šå¼·ã€‚</div>
                <input type="range" id="length-range" min="10" max="60" value="30" step="1">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:4px; text-align:center;">
                    <div style="font-size:0.7rem; color:#888;">å‹åº¦ä¿‚æ•¸ (k)</div>
                    <div id="k-value" style="font-family:'Orbitron'; color:#ffcc00;">50</div>
                </div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:4px; text-align:center;">
                    <div style="font-size:0.7rem; color:#888;">æœ€å¤§ä½èƒ½ (PE)</div>
                    <div id="e-value" style="font-family:'Orbitron'; color:#ffcc00;">100 J</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <button class="action-btn" style="padding: 15px; font-size: 1rem; background: linear-gradient(135deg, #ff6b6b, #ee5a6f);" onclick="openVehicleLibrary()">è»Šè¼›åº«</button>
                <button class="action-btn" style="padding: 15px; font-size: 1rem; background: linear-gradient(135deg, #4ecdc4, #44a08d);" onclick="saveVehicleDesign()">å„²å­˜è¨­è¨ˆ</button>
            </div>

            <button class="action-btn" onclick="startSequence()">é–‹å§‹æ¯”è³½ (START)</button>
        </div>

        <!-- Countdown -->
        <div id="countdown">3</div>

        <!-- HUD -->
        <div id="hud">
            <!-- Pause Button (Top Left) -->
            <button id="pause-btn" style="display: none;">â¸ æš«åœ</button>
            
            <!-- Timer (Top Right) -->
            <div id="timer" style="display: none;">
                <div class="timer-label">ç”¨æ™‚</div>
                <div id="timer-display" class="timer-val">00:00</div>
            </div>

            <!-- Mini Map (Bottom Left) -->
            <div id="mini-map">
                <div class="racer-row">
                    <div class="racer-label">
                        <span style="color: #00d2ff; font-weight: bold;" id="p1-name">æœªå‘½å</span>
                        <span id="p1-rank">1st</span>
                    </div>
                    <div class="progress-track"><div id="p1-bar" class="progress-bar" style="background: #00d2ff;"></div></div>
                </div>
                <div class="racer-row">
                    <div class="racer-label">
                        <span style="color: #ff4444;" id="ai1-name">å‹æ•µ</span>
                        <span id="ai1-rank">2nd</span>
                    </div>
                    <div class="progress-track"><div id="ai1-bar" class="progress-bar" style="background: #ff4444;"></div></div>
                </div>
                <div class="racer-row">
                    <div class="racer-label">
                        <span style="color: #ffe66d;">æ…¢éƒä¸­</span>
                        <span id="ai2-rank">3rd</span>
                    </div>
                    <div class="progress-track"><div id="ai2-bar" class="progress-bar" style="background: #ffe66d;"></div></div>
                </div>
                <div class="racer-row">
                    <div class="racer-label">
                        <span style="color: #00ffaa;">æ€¥é©šé¢¨</span>
                        <span id="ai3-rank">4th</span>
                    </div>
                    <div class="progress-track"><div id="ai3-bar" class="progress-bar" style="background: #00ffaa;"></div></div>
                </div>
                <div class="racer-row">
                    <div class="racer-label">
                        <span style="color: #aa00ff;">å¤§åŠ›å£«</span>
                        <span id="ai4-rank">5th</span>
                    </div>
                    <div class="progress-track"><div id="ai4-bar" class="progress-bar" style="background: #aa00ff;"></div></div>
                </div>
            </div>

            <!-- Speedometer (Bottom Right) -->
            <div id="speedometer">
                <div id="speed-display" class="speed-val">0</div>
                <div class="speed-unit">KM/H</div>
            </div>
        </div>

        <!-- Tension Feedback -->
        <div id="tension-ui">
            <div class="tension-val" id="tension-text">0 N</div>
            <div class="pull-hint">â†“ å‘å¾Œæ‹‰å‹•è“„åŠ›ï¼Œæ”¾é–‹è¡åˆº</div>
        </div>

        <!-- Results -->
        <div id="end-screen">
            <h1 class="end-screen-title">æ¯”è³½çµæŸ</h1>
            <div class="end-screen-subtitle" id="end-screen-subtitle">æ­å–œå®Œæˆæ¯”è³½ï¼</div>
            
            <div class="end-screen-content">
                <div class="rank-card">
                    <h3>ğŸ† æœ¬å±€æ’å</h3>
                    <div id="player-result" class="player-result-card" style="display: none;"></div>
                    <div id="rank-list"></div>
                </div>
                <div class="leaderboard-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">â­ æœ€å¿«æˆç¸¾æ’è¡Œæ¦œ</h3>
                        <button id="clear-leaderboard-btn" class="action-btn" style="padding: 8px 15px; font-size: 0.85rem; background: rgba(255,100,100,0.3); border: 1px solid rgba(255,100,100,0.5); pointer-events: auto; cursor: pointer;" type="button" onclick="clearLeaderboard()">æ¸…é™¤è¨˜éŒ„</button>
                    </div>
                    <div id="leaderboard-list"></div>
                </div>
            </div>
            
            <div class="end-screen-buttons">
                <button class="action-btn" style="padding: 15px 30px; font-size: 1.1rem;" onclick="returnToMainMenu()">è¿”å›ä¸»ç›®éŒ„</button>
            </div>
        </div>

        <!-- Vehicle Library Modal -->
        <div id="vehicle-library-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; touch-action: auto; pointer-events: auto;" onclick="if(event.target.id === 'vehicle-library-modal') { window.closeVehicleLibrary && window.closeVehicleLibrary(); }">
            <div style="background: rgba(15, 20, 35, 0.98); border: 2px solid rgba(0,210,255,0.5); border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0,210,255,0.3); position: relative; pointer-events: auto;" onclick="event.stopPropagation();">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: 'Orbitron'; color: #00d2ff; margin: 0;">è»Šè¼›åº«</h2>
                    <button id="close-library-btn" onclick="window.closeVehicleLibrary && window.closeVehicleLibrary(); return false;" type="button" style="background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; line-height: 1; pointer-events: auto; z-index: 301;">Ã—</button>
                </div>
                <div id="vehicle-list" style="display: flex; flex-direction: column; gap: 15px; pointer-events: auto;">
                    <!-- Vehicles will be loaded here -->
                </div>
                <div style="margin-top: 20px; text-align: center; color: #888; font-size: 0.9rem;" id="empty-library-message" style="display: none;">
                    é‚„æ²’æœ‰å„²å­˜çš„è»Šè¼›è¨­è¨ˆ
                </div>
            </div>
        </div>

        <!-- Save Vehicle Modal -->
        <div id="save-vehicle-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; touch-action: auto; pointer-events: auto;" onclick="if(event.target.id === 'save-vehicle-modal') { window.closeSaveModal && window.closeSaveModal(); }">
            <div style="background: rgba(15, 20, 35, 0.98); border: 2px solid rgba(0,210,255,0.5); border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 0 50px rgba(0,210,255,0.3); position: relative; pointer-events: auto;" onclick="event.stopPropagation();">
                <h2 style="font-family: 'Orbitron'; color: #00d2ff; margin: 0 0 20px 0;">å„²å­˜è»Šè¼›è¨­è¨ˆ</h2>
                <input type="text" id="vehicle-name-input" placeholder="è¼¸å…¥è»Šè¼›åç¨±..." maxlength="20" autofocus style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #334455; border-radius: 5px; color: white; font-size: 1rem; margin-bottom: 20px; font-family: 'Noto Sans TC'; pointer-events: auto; box-sizing: border-box;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="action-btn" id="cancel-save-btn" style="padding: 12px; font-size: 1rem; background: rgba(255,255,255,0.1); pointer-events: auto; cursor: pointer;" type="button">å–æ¶ˆ</button>
                    <button class="action-btn" id="confirm-save-btn" style="padding: 12px; font-size: 1rem; pointer-events: auto; cursor: pointer;" type="button">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- Pause Menu -->
        <div id="pause-menu" onclick="if(event.target.id === 'pause-menu') { resumeGame(); }">
            <div class="pause-menu-card" onclick="event.stopPropagation();">
                <div class="pause-menu-title">éŠæˆ²æš«åœ</div>
                <button class="pause-menu-btn" id="resume-btn" type="button">ç¹¼çºŒéŠæˆ²</button>
                <button class="pause-menu-btn secondary" id="restart-btn" type="button">é‡æ–°é–‹å§‹</button>
                <button class="pause-menu-btn secondary" id="main-menu-btn" type="button">è¿”å›ä¸»ç›®éŒ„</button>
            </div>
        </div>

        <!-- Science Principle Modal -->
        <div id="science-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; touch-action: auto; pointer-events: auto;" onclick="if(event.target.id === 'science-modal') { closeScienceModal(); }">
            <div style="background: rgba(15, 20, 35, 0.98); border: 2px solid rgba(0,210,255,0.5); border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0,210,255,0.3); position: relative; pointer-events: auto;" onclick="event.stopPropagation();">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="science-modal-title" style="font-family: 'Orbitron'; color: #00d2ff; margin: 0;"></h2>
                    <button id="close-science-btn" onclick="window.closeScienceModal && window.closeScienceModal(); return false;" style="background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; width: 35px; height: 35px; min-width: 35px; min-height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; line-height: 1; transition: all 0.2s; pointer-events: auto !important; z-index: 301; position: relative; flex-shrink: 0;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" type="button">Ã—</button>
                </div>
                <div id="science-modal-content" style="color: #ddd; line-height: 1.8; font-size: 1rem;">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const CONFIG = {
            finishLine: 1500, 
            carMass: 15, 
            baseFriction: 0.99, 
            baseDrag: 0.0008, 
            maxPull: 25,
            // Physics constants
            MIN_VELOCITY: 0.01,
            WHEEL_ROTATION_MULT: 0.2,
            FORCE_MULTIPLIER: 0.15,
            SPEED_TO_KMH: 200,
            // UI constants
            PULL_THRESHOLD: 10,
            MAX_PULL_DELTA: 300,
            CAMERA_LERP: 0.05,
            // Performance
            THROTTLE_MS: 16 // ~60fps
        };

        const state = {
            phase: 'setup', time: 0, finishOrder: [],
            paused: false,
            raceStartTime: 0,
            elapsedTime: 0,
            pauseStartTime: 0,
            // Player friction/drag defaults with design parameters
            player: { 
                id: 'p1', 
                name: '', 
                x: 0, 
                v: 0, 
                k: 50, 
                color: 0x00d2ff, 
                finished: false, 
                frictionMult: 1, 
                dragMult: 1,
                // Design parameters
                design: {
                    wheelCount: 4,
                    wheelSize: 'medium',
                    bodyLength: 'medium',
                    bodyWidth: 'medium',
                    bodyWeight: 'medium'
                },
                // Calculated physics properties
                totalMass: 15,
                totalFriction: 0.99,
                totalDrag: 0.0008
            },
            
            // AI Configs (Initialized with safe defaults, overwritten in startSequence)
            ai1: { id: 'ai1', name: 'å‹æ•µ', x: 0, v: 0, k: 50, color: 0xff4444, finished: false, status: 'idle', nextAction: 0, chargeStart: 0, chargeDuration: 1000, targetPull: 15, baseCooldown: 1000 },
            ai2: { id: 'ai2', name: 'æ…¢éƒä¸­', x: 0, v: 0, k: 25, color: 0xffe66d, finished: false, status: 'idle', nextAction: 0, chargeStart: 0, chargeDuration: 2500, targetPull: 10, baseCooldown: 2000 },
            ai3: { id: 'ai3', name: 'æ€¥é©šé¢¨', x: 0, v: 0, k: 40, color: 0x00ffaa, finished: false, status: 'idle', nextAction: 0, chargeStart: 0, chargeDuration: 500, targetPull: 12, baseCooldown: 800 }, 
            ai4: { id: 'ai4', name: 'å¤§åŠ›å£«', x: 0, v: 0, k: 70, color: 0xaa00ff, finished: false, status: 'idle', nextAction: 0, chargeStart: 0, chargeDuration: 1800, targetPull: 20, baseCooldown: 1500 }, 

            input: { dragging: false, startY: 0, tension: 0 },
            camera: { target: new THREE.Vector3(10, 10, 15), look: new THREE.Vector3(0,0,0) }
        };

        // Cache DOM elements for performance
        const DOM = {
            garage: null,
            hud: null,
            countdown: null,
            tensionUI: null,
            tensionText: null,
            speedDisplay: null,
            endScreen: null,
            rankList: null,
            kValue: null,
            eValue: null
        };

        // Initialize DOM cache
        function initDOMCache() {
            DOM.garage = document.getElementById('garage');
            DOM.hud = document.getElementById('hud');
            DOM.countdown = document.getElementById('countdown');
            DOM.tensionUI = document.getElementById('tension-ui');
            DOM.tensionText = document.getElementById('tension-text');
            DOM.speedDisplay = document.getElementById('speed-display');
            DOM.endScreen = document.getElementById('end-screen');
            DOM.rankList = document.getElementById('rank-list');
            DOM.kValue = document.getElementById('k-value');
            DOM.eValue = document.getElementById('e-value');
            DOM.leaderboardList = document.getElementById('leaderboard-list');
        }

        // --- LEADERBOARD STORAGE ---
        // æ’è¡Œæ¦œä½¿ç”¨ç€è¦½å™¨çš„ localStorage å„²å­˜
        // è¨˜éŒ„æœƒæ°¸ä¹…ä¿å­˜ï¼Œç›´åˆ°ï¼š
        // 1. ç”¨æˆ¶é»æ“Šã€Œæ¸…é™¤è¨˜éŒ„ã€æŒ‰éˆ•
        // 2. ç”¨æˆ¶æ¸…é™¤ç€è¦½å™¨æ•¸æ“šï¼ˆæ¸…é™¤å¿«å–ã€Cookieç­‰ï¼‰
        // 3. ä½¿ç”¨ç„¡ç—•æ¨¡å¼æ™‚ï¼Œé—œé–‰è¦–çª—å¾Œæœƒæ¸…é™¤
        const LeaderboardStorage = {
            STORAGE_KEY: 'elastic_racer_leaderboard',
            
            save(record) {
                const records = this.getAll();
                records.push(record);
                // Sort by time (ascending - fastest first)
                records.sort((a, b) => a.time - b.time);
                // Keep only top 10
                const top10 = records.slice(0, 10);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(top10));
            },
            
            getAll() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    return [];
                }
            },
            
            clear() {
                localStorage.removeItem(this.STORAGE_KEY);
            }
        };

        // --- VEHICLE STORAGE ---
        const VehicleStorage = {
            STORAGE_KEY: 'elastic_racer_vehicles',
            
            // ç²å–æ‰€æœ‰å„²å­˜çš„è»Šè¼›
            getAll: function() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error('è®€å–è»Šè¼›è³‡æ–™å¤±æ•—:', e);
                    return [];
                }
            },
            
            // å„²å­˜è»Šè¼›è¨­è¨ˆ
            save: function(vehicle) {
                try {
                    const vehicles = this.getAll();
                    vehicle.id = vehicle.id || Date.now();
                    vehicle.timestamp = vehicle.timestamp || new Date().toISOString();
                    vehicles.push(vehicle);
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(vehicles));
                    return true;
                } catch (e) {
                    console.error('å„²å­˜è»Šè¼›å¤±æ•—:', e);
                    return false;
                }
            },
            
            // åˆªé™¤è»Šè¼›
            delete: function(id) {
                try {
                    const vehicles = this.getAll();
                    const filtered = vehicles.filter(v => v.id !== id);
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filtered));
                    return true;
                } catch (e) {
                    console.error('åˆªé™¤è»Šè¼›å¤±æ•—:', e);
                    return false;
                }
            },
            
            // è¼‰å…¥è»Šè¼›è¨­è¨ˆåˆ°ç•¶å‰é…ç½®
            load: function(vehicle) {
                if (!vehicle || !vehicle.config) return false;
                
                const config = vehicle.config;
                
                // æ›´æ–°æ‰€æœ‰è¡¨å–®å…ƒç´ 
                if (config.wheelType) document.getElementById('wheel-select').value = config.wheelType;
                if (config.wheelCount) {
                    document.getElementById('wheel-count-range').value = config.wheelCount;
                    const display = document.getElementById('wheel-count-display');
                    if (display) display.innerText = config.wheelCount + ' å€‹è¼ªå­';
                }
                if (config.wheelSize) document.getElementById('wheel-size-select').value = config.wheelSize;
                if (config.bodyLength) document.getElementById('body-length-select').value = config.bodyLength;
                if (config.bodyWidth) document.getElementById('body-width-select').value = config.bodyWidth;
                if (config.bodyWeight) document.getElementById('body-weight-select').value = config.bodyWeight;
                if (config.aero) document.getElementById('aero-select').value = config.aero;
                if (config.material) document.getElementById('material-select').value = config.material;
                if (config.thickness) document.getElementById('thickness-range').value = config.thickness;
                if (config.length) document.getElementById('length-range').value = config.length;
                
                // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
                if (typeof updateStats === 'function') updateStats();
                
                return true;
            }
        };

        // --- VEHICLE LIBRARY UI ---
        function openVehicleLibrary() {
            const modal = document.getElementById('vehicle-library-modal');
            const list = document.getElementById('vehicle-list');
            const emptyMsg = document.getElementById('empty-library-message');
            
            if (!modal || !list) return;
            
            const vehicles = VehicleStorage.getAll();
            
            list.innerHTML = '';
            emptyMsg.style.display = vehicles.length === 0 ? 'block' : 'none';
            
            vehicles.forEach(vehicle => {
                const card = document.createElement('div');
                card.style.cssText = 'background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);';
                
                const config = vehicle.config || {};
                const summary = [
                    config.wheelCount ? `${config.wheelCount}è¼ª` : '',
                    config.wheelSize || '',
                    config.bodyWeight || '',
                    config.aero || ''
                ].filter(Boolean).join(' Â· ') || 'é è¨­é…ç½®';
                
                // Create buttons with data attributes instead of inline onclick
                const loadBtn = document.createElement('button');
                loadBtn.textContent = 'è¼‰å…¥';
                loadBtn.className = 'vehicle-load-btn';
                loadBtn.setAttribute('data-vehicle-id', vehicle.id);
                loadBtn.style.cssText = 'padding: 8px; background: linear-gradient(135deg, #00d2ff, #007bff); border: none; color: white; border-radius: 5px; cursor: pointer; font-size: 0.9rem; pointer-events: auto;';
                loadBtn.type = 'button';
                
                const compareBtn = document.createElement('button');
                compareBtn.textContent = 'æ¯”è¼ƒ';
                compareBtn.className = 'vehicle-compare-btn';
                compareBtn.setAttribute('data-vehicle-id', vehicle.id);
                compareBtn.style.cssText = 'padding: 8px; background: linear-gradient(135deg, #ff6b6b, #ee5a6f); border: none; color: white; border-radius: 5px; cursor: pointer; font-size: 0.9rem; pointer-events: auto;';
                compareBtn.type = 'button';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'åˆªé™¤';
                deleteBtn.className = 'vehicle-delete-btn';
                deleteBtn.setAttribute('data-vehicle-id', vehicle.id);
                deleteBtn.style.cssText = 'padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; border-radius: 5px; cursor: pointer; font-size: 0.9rem; pointer-events: auto;';
                deleteBtn.type = 'button';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; color: #00d2ff; margin-bottom: 5px; font-size: 1.1rem;">${vehicle.name || 'æœªå‘½åè»Šè¼›'}</div>
                            <div style="color: #888; font-size: 0.85rem;">${summary}</div>
                            <div style="color: #666; font-size: 0.75rem; margin-top: 5px;">${new Date(vehicle.timestamp).toLocaleString('zh-TW')}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; pointer-events: auto;">
                    </div>
                `;
                
                const buttonContainer = card.querySelector('div[style*="grid-template-columns"]');
                buttonContainer.appendChild(loadBtn);
                buttonContainer.appendChild(compareBtn);
                buttonContainer.appendChild(deleteBtn);
                
                list.appendChild(card);
            });
            
            modal.style.display = 'flex';
        }

        function closeVehicleLibrary() {
            const modal = document.getElementById('vehicle-library-modal');
            if (modal) modal.style.display = 'none';
        }

        function loadVehicleDesign(id) {
            const vehicles = VehicleStorage.getAll();
            const vehicle = vehicles.find(v => v.id === id);
            if (vehicle) {
                VehicleStorage.load(vehicle);
                // Set player name from vehicle
                if (vehicle.name) {
                    state.player.name = vehicle.name;
                }
                updateMainVehicle(); // Update main scene vehicle
                closeVehicleLibrary();
                // Show garage after loading
                showGarage();
            }
        }

        function deleteVehicle(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è»Šè¼›è¨­è¨ˆå—ï¼Ÿ')) {
                VehicleStorage.delete(id);
                openVehicleLibrary(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            }
        }
        
        // Make functions globally accessible
        window.openVehicleLibrary = openVehicleLibrary;
        window.closeVehicleLibrary = closeVehicleLibrary;
        window.loadVehicleDesign = loadVehicleDesign;
        window.deleteVehicle = deleteVehicle;
        window.compareVehicle = compareVehicle;
        
        // Bind buttons using event delegation
        document.addEventListener('click', function(e) {
            const target = e.target;
            
            if (target.classList.contains('vehicle-load-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const id = parseInt(target.getAttribute('data-vehicle-id'));
                if (id) loadVehicleDesign(id);
            } else if (target.classList.contains('vehicle-compare-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const id = parseInt(target.getAttribute('data-vehicle-id'));
                if (id) compareVehicle(id);
            } else if (target.classList.contains('vehicle-delete-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const id = parseInt(target.getAttribute('data-vehicle-id'));
                if (id) deleteVehicle(id);
            } else if (target.id === 'close-library-btn' || target.closest('#close-library-btn')) {
                e.preventDefault();
                e.stopPropagation();
                closeVehicleLibrary();
            }
        }, true); // Use capture phase

        // --- SAVE VEHICLE ---
        function saveVehicleDesign() {
            const modal = document.getElementById('save-vehicle-modal');
            const input = document.getElementById('vehicle-name-input');
            if (modal) {
                if (input) {
                    input.value = '';
                    // Focus input after modal is shown
                    setTimeout(() => {
                        input.focus();
                    }, 100);
                }
                modal.style.display = 'flex';
            }
        }

        function closeSaveModal() {
            const modal = document.getElementById('save-vehicle-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function confirmSaveVehicle() {
            const input = document.getElementById('vehicle-name-input');
            const name = (input && input.value.trim()) || `è»Šè¼›è¨­è¨ˆ ${new Date().toLocaleString('zh-TW')}`;
            
            // æ”¶é›†ç•¶å‰è¨­è¨ˆ
            const design = {
                wheelType: document.getElementById('wheel-select').value,
                wheelCount: parseInt(document.getElementById('wheel-count-range').value),
                wheelSize: document.getElementById('wheel-size-select').value,
                bodyLength: document.getElementById('body-length-select').value,
                bodyWidth: document.getElementById('body-width-select').value,
                bodyWeight: document.getElementById('body-weight-select').value,
                aero: document.getElementById('aero-select').value,
                material: document.getElementById('material-select').value,
                thickness: parseFloat(document.getElementById('thickness-range').value),
                length: parseFloat(document.getElementById('length-range').value)
            };
            
            // è¨ˆç®—æ€§èƒ½æŒ‡æ¨™
            const mat = parseFloat(design.material);
            const k = Math.min(200, (mat * design.thickness * 5) / (design.length/5));
            
            const vehicle = {
                name: name,
                config: design,
                stats: {
                    calculatedK: k,
                    calculatedPE: Math.round(0.5 * k * 225)
                }
            };
            
            if (VehicleStorage.save(vehicle)) {
                alert('è»Šè¼›è¨­è¨ˆå·²å„²å­˜ï¼');
                closeSaveModal();
            } else {
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
            }
        }
        
        // Make functions globally accessible
        window.saveVehicleDesign = saveVehicleDesign;
        window.closeSaveModal = closeSaveModal;
        window.confirmSaveVehicle = confirmSaveVehicle;
        
        // Bind buttons after DOM is ready
        setTimeout(() => {
            const cancelBtn = document.getElementById('cancel-save-btn');
            const confirmBtn = document.getElementById('confirm-save-btn');
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeSaveModal();
                });
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    confirmSaveVehicle();
                });
            }
            
            // Also support Enter key in input
            const input = document.getElementById('vehicle-name-input');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmSaveVehicle();
                    }
                });
            }
        }, 0);

        // --- COMPARE VEHICLES ---
        let compareMode = {
            active: false,
            vehicle1: null,
            vehicle2: null
        };

        function compareVehicle(id) {
            const vehicles = VehicleStorage.getAll();
            const vehicle = vehicles.find(v => v.id === id);
            if (!vehicle) return;
            
            // ç›´æ¥ç”¨ç•¶å‰è»Šè¼›é…ç½®å’Œé¸æ“‡çš„è»Šè¼›æ¯”è¼ƒ
            // æ”¶é›†ç•¶å‰ç©å®¶è»Šè¼›é…ç½®
            const currentDesign = {
                wheelType: document.getElementById('wheel-select').value,
                wheelCount: parseInt(document.getElementById('wheel-count-range').value),
                wheelSize: document.getElementById('wheel-size-select').value,
                bodyLength: document.getElementById('body-length-select').value,
                bodyWidth: document.getElementById('body-width-select').value,
                bodyWeight: document.getElementById('body-weight-select').value,
                aero: document.getElementById('aero-select').value,
                material: document.getElementById('material-select').value,
                thickness: parseFloat(document.getElementById('thickness-range').value),
                length: parseFloat(document.getElementById('length-range').value)
            };
            
            const currentVehicle = {
                name: state.player.name || 'ç•¶å‰è¨­è¨ˆ',
                config: currentDesign
            };
            
            compareMode.vehicle1 = currentVehicle;
            compareMode.vehicle2 = vehicle;
            compareMode.active = true;
            
            closeVehicleLibrary();
            startComparison();
        }

        function startComparison() {
            if (!compareMode.vehicle1 || !compareMode.vehicle2) return;
            
            // è¼‰å…¥ç¬¬ä¸€è¼›è»Šä½œç‚ºç©å®¶è»Šè¼›ï¼ˆå¦‚æœæ˜¯ç•¶å‰è¨­è¨ˆï¼Œä¸éœ€è¦è¼‰å…¥ï¼Œå·²ç¶“åœ¨è¡¨å–®ä¸­ï¼‰
            const isCurrentDesign = !compareMode.vehicle1.id; // ç•¶å‰è¨­è¨ˆæ²’æœ‰id
            if (!isCurrentDesign) {
                VehicleStorage.load(compareMode.vehicle1);
            }
            
            // æ›´æ–°ç©å®¶åç¨±
            state.player.name = compareMode.vehicle1.name || state.player.name || 'æœªå‘½å';
            
            // å¦‚æœä½¿ç”¨ç•¶å‰è¨­è¨ˆï¼Œéœ€è¦æ›´æ–°ä¸»å ´æ™¯è»Šè¼›
            if (isCurrentDesign) {
                updateMainVehicle();
            }
            
            // è¨­ç½®ç¬¬äºŒè¼›è»Šçš„é…ç½®çµ¦ai1ï¼ˆå‹æ•µï¼‰
            const vehicle2Config = compareMode.vehicle2.config;
            if (vehicle2Config) {
                // è¨ˆç®—ç¬¬äºŒè¼›è»Šçš„ç‰©ç†å±¬æ€§
                const physics2 = calculateVehiclePhysics(vehicle2Config);
                const mat2 = parseFloat(vehicle2Config.material || 1.0);
                const k2 = Math.min(200, (mat2 * vehicle2Config.thickness * 5) / (vehicle2Config.length/5));
                
                // è¨­ç½®ai1ä½¿ç”¨ç¬¬äºŒè¼›è»Šçš„é…ç½®
                state.ai1.design = JSON.parse(JSON.stringify(vehicle2Config)); // Deep copy
                state.ai1.totalMass = physics2.totalMass;
                state.ai1.totalFriction = physics2.totalFriction;
                state.ai1.totalDrag = physics2.totalDrag;
                state.ai1.k = k2;
                state.ai1.name = compareMode.vehicle2.name;
                state.ai1.targetPull = 15; // Default pull strength
                
                // é‡æ–°å‰µå»ºai1çš„è»Šè¼›
                if (ai1Car && scene.children.includes(ai1Car)) {
                    scene.remove(ai1Car);
                }
                ai1Car = createCar(state.ai1.color, false, vehicle2Config);
                ai1Car.position.set(0, 0, -6);
                scene.add(ai1Car);
                
                // ç¢ºä¿å…¶ä»–AIè»Šè¼›ä¹Ÿå­˜åœ¨
                if (!ai2Car) {
                    ai2Car = createCar(state.ai2.color, false);
                    ai2Car.position.set(0, 0, -12);
                    scene.add(ai2Car);
                }
                if (!ai3Car) {
                    ai3Car = createCar(state.ai3.color, false);
                    ai3Car.position.set(0, 0, 6);
                    scene.add(ai3Car);
                }
                if (!ai4Car) {
                    ai4Car = createCar(state.ai4.color, false);
                    ai4Car.position.set(0, 0, 12);
                    scene.add(ai4Car);
                }
            }
            
            // æ›´æ–°HUDä¸­çš„åç¨±é¡¯ç¤º
            const p1NameEl = document.getElementById('p1-name');
            const ai1NameEl = document.getElementById('ai1-name');
            if (p1NameEl) p1NameEl.textContent = state.player.name;
            if (ai1NameEl) ai1NameEl.textContent = state.ai1.name;
            
            alert(`æ¯”è¼ƒæ¨¡å¼ï¼š\n${compareMode.vehicle1.name} vs ${compareMode.vehicle2.name}\n\né–‹å§‹æ¯”è³½ï¼`);
            startSequence();
            
            // é‡ç½®æ¯”è¼ƒæ¨¡å¼
            compareMode = { active: false, vehicle1: null, vehicle2: null };
        }

        // --- SCIENCE PRINCIPLE MODAL ---
        const sciencePrinciples = {
            'material-select': {
                title: 'æ©¡çš®ç­‹æè³ª',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">ä¸åŒçš„æ©¡çš®ç­‹æè³ªï¼Œå°±åƒä¸åŒçš„å½ˆç°§ä¸€æ¨£ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>ç¡¬çš„æè³ª</strong>ï¼ˆåƒå·¥æ¥­ç”¨å½ˆåŠ›ç¹©ï¼‰â†’ å¯ä»¥å„²å­˜æ›´å¤šèƒ½é‡ï¼Œè»Šå­æœƒè·‘å¾—æ›´å¿«ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>è»Ÿçš„æè³ª</strong>ï¼ˆåƒèˆŠé«®åœˆï¼‰â†’ å„²å­˜çš„èƒ½é‡è¼ƒå°‘ï¼Œè»Šå­è·‘å¾—è¼ƒæ…¢</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šè¶Šç¡¬çš„æ©¡çš®ç­‹ï¼Œå°±åƒè¶Šå¼·çš„å½ˆç°§ï¼Œå¯ä»¥è®“è»Šå­è·‘å¾—æ›´é ï¼</p>
                `
            },
            'wheel-count-range': {
                title: 'è¼ªå­æ•¸é‡',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">è¼ªå­è¶Šå¤šï¼Œè»Šå­è¶Šç©©ï¼Œä½†å•Ÿå‹•æœƒè®Šæ…¢ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>2-4å€‹è¼ªå­</strong> â†’ å•Ÿå‹•å¿«ï¼Œé©åˆå¿«é€Ÿè¡åˆº</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>10å€‹è¼ªå­</strong> â†’ éå¸¸ç©©ï¼Œä½†å•Ÿå‹•å¾ˆæ…¢å¾ˆæ…¢</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šå°±åƒè…³è¶Šå¤šè¶Šç©©ï¼Œä½†è·‘èµ·ä¾†æœƒè®Šæ…¢ä¸€æ¨£ï¼</p>
                `
            },
            'wheel-size-select': {
                title: 'è¼ªå­å¤§å°',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">è¼ªå­å¤§å°æœƒå½±éŸ¿è»Šå­çš„é€Ÿåº¦ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>å°è¼ªå­</strong> â†’ è¼•ï¼Œå•Ÿå‹•å¿«ï¼Œä½†å®¹æ˜“åœä¸‹ä¾†</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>å¤§è¼ªå­</strong> â†’ é‡ï¼Œå•Ÿå‹•æ…¢ï¼Œä½†å¯ä»¥æ»¾å¾ˆé </p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>ä¸­è¼ªå­</strong> â†’ å‰›å‰›å¥½ï¼Œå¹³è¡¡æœ€å¥½</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šå°±åƒå°çƒå®¹æ˜“åœï¼Œå¤§çƒå¯ä»¥æ»¾å¾ˆé ä¸€æ¨£ï¼</p>
                `
            },
            'body-length-select': {
                title: 'è»Šèº«é•·åº¦',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">è»Šèº«é•·åº¦æœƒå½±éŸ¿é¢¨çš„é˜»åŠ›ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>çŸ­è»Šèº«</strong> â†’ é¢¨çš„é˜»åŠ›å°ï¼Œè·‘å¾—å¿«ï¼Œä½†å®¹æ˜“ä¸ç©©</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>é•·è»Šèº«</strong> â†’ é¢¨çš„é˜»åŠ›å¤§ï¼Œä½†è»Šå­æ›´ç©©</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šå°±åƒçŸ­ç®­é£›å¾—å¿«ï¼Œé•·ç®­æ›´ç©©ä¸€æ¨£ï¼</p>
                `
            },
            'body-weight-select': {
                title: 'è»Šå­é‡é‡',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">è»Šå­é‡é‡æœƒå½±éŸ¿å•Ÿå‹•å’Œæ»‘è¡Œï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>è¼•è»Š</strong> â†’ å•Ÿå‹•å¿«ï¼Œä½†å®¹æ˜“åœä¸‹ä¾†</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>é‡è»Š</strong> â†’ å•Ÿå‹•æ…¢ï¼Œä½†å¯ä»¥æ»‘è¡Œå¾ˆé </p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šå°±åƒè¼•çƒå®¹æ˜“åœï¼Œé‡çƒå¯ä»¥æ»¾å¾ˆé ä¸€æ¨£ï¼</p>
                `
            },
            'wheel-select': {
                title: 'è¼ªèƒé¡å‹',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">ä¸åŒçš„è¼ªèƒï¼Œå°±åƒä¸åŒçš„é‹å­ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>å…‰é ­èƒ</strong> â†’ åƒæºœå†°é‹ï¼Œå¾ˆæ»‘ï¼Œå¯ä»¥æ»‘å¾ˆé </p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>æ¨™æº–èƒ</strong> â†’ åƒæ™®é€šé‹å‹•é‹ï¼Œå‰›å‰›å¥½</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>è¶Šé‡èƒ</strong> â†’ åƒç™»å±±é‹ï¼ŒæŠ“åœ°åŠ›å¼·ï¼Œä½†å®¹æ˜“åœä¸‹ä¾†</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šæƒ³è¦æ»‘å¾—é é¸å…‰é ­èƒï¼Œæƒ³è¦æŠ“åœ°åŠ›å¼·é¸è¶Šé‡èƒï¼</p>
                `
            },
            'aero-select': {
                title: 'ç©ºæ°£å‹•åŠ›',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">è»Šå­çš„å½¢ç‹€æœƒå½±éŸ¿é¢¨çš„é˜»åŠ›ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>æµç·šå‹</strong> â†’ åƒé­šçš„å½¢ç‹€ï¼Œé¢¨çš„é˜»åŠ›å°ï¼Œè·‘å¾—å¿«</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>åŸå» </strong> â†’ æ™®é€šå½¢ç‹€ï¼Œé¢¨çš„é˜»åŠ›ä¸€èˆ¬</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>é‡è£ç”²</strong> â†’ åƒæ–¹ç›’å­ï¼Œé¢¨çš„é˜»åŠ›å¤§ï¼Œå®¹æ˜“åœä¸‹ä¾†</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šæµç·šå‹å°±åƒé­šæ¸¸å¾—å¿«ï¼Œæ–¹ç›’å­å®¹æ˜“è¢«é¢¨æ“‹ä½ï¼</p>
                `
            },
            'thickness-range': {
                title: 'æ©¡çš®ç­‹åšåº¦',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">æ©¡çš®ç­‹è¶Šç²—ï¼Œå¯ä»¥å„²å­˜è¶Šå¤šèƒ½é‡ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>ç´°æ©¡çš®ç­‹</strong> â†’ å®¹æ˜“æ‹‰ï¼Œä½†èƒ½é‡å°‘</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>ç²—æ©¡çš®ç­‹</strong> â†’ é›£æ‹‰ï¼Œä½†èƒ½é‡å¤šï¼Œè»Šå­è·‘å¾—é </p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šå°±åƒç²—å½ˆç°§æ¯”ç´°å½ˆç°§æ›´æœ‰åŠ›ä¸€æ¨£ï¼</p>
                `
            },
            'length-range': {
                title: 'æ©¡çš®ç­‹é•·åº¦',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">æ©¡çš®ç­‹è¶ŠçŸ­ï¼Œçˆ†ç™¼åŠ›è¶Šå¼·ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>çŸ­æ©¡çš®ç­‹</strong> â†’ å¾ˆç·Šï¼Œçˆ†ç™¼åŠ›å¼·ï¼Œé©åˆå¿«é€Ÿè¡åˆº</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>é•·æ©¡çš®ç­‹</strong> â†’ è¼ƒé¬†ï¼Œçˆ†ç™¼åŠ›å¼±ï¼Œä½†å¯ä»¥æ…¢æ…¢åŠ é€Ÿ</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šå°±åƒçŸ­å½ˆç°§å½ˆå¾—å¿«ï¼Œé•·å½ˆç°§å½ˆå¾—æ…¢ä¸€æ¨£ï¼</p>
                `
            },
            'body-width-select': {
                title: 'è»Šèº«å¯¬åº¦',
                content: `
                    <p style="font-size: 1.1rem; line-height: 1.8;">ğŸ¯ <strong>ç°¡å–®ä¾†èªªï¼š</strong></p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">è»Šèº«å¯¬åº¦æœƒå½±éŸ¿é¢¨çš„é˜»åŠ›å’Œè¼ªå­ç©ºé–“ï¼</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>çª„è»Šèº«</strong> â†’ é¢¨çš„é˜»åŠ›å°ï¼Œè·‘å¾—å¿«</p>
                    <p style="font-size: 1.1rem; line-height: 1.8;">â€¢ <strong>å¯¬è»Šèº«</strong> â†’ é¢¨çš„é˜»åŠ›å¤§ï¼Œä½†å¯ä»¥æ”¾æ›´å¤šè¼ªå­</p>
                    <p style="font-size: 1.1rem; line-height: 1.8; margin-top: 15px; color: #00d2ff;">ğŸ’¡ è¨˜ä½ï¼šçª„è»Šèº«åƒç®­ä¸€æ¨£å¿«ï¼Œå¯¬è»Šèº«å¯ä»¥æ”¾æ›´å¤šè¼ªå­ï¼</p>
                `
            }
        };

        function showSciencePrinciple(elementId) {
            const principle = sciencePrinciples[elementId];
            if (!principle) return;
            
            const modal = document.getElementById('science-modal');
            const title = document.getElementById('science-modal-title');
            const content = document.getElementById('science-modal-content');
            
            if (modal && title && content) {
                title.textContent = principle.title;
                content.innerHTML = principle.content;
                modal.style.display = 'flex';
            }
        }

        function closeScienceModal() {
            const modal = document.getElementById('science-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Make function globally accessible immediately
        window.closeScienceModal = closeScienceModal;
        
        // Also bind via event delegation as backup
        document.addEventListener('click', function(e) {
            if (e.target && (e.target.id === 'close-science-btn' || e.target.closest('#close-science-btn'))) {
                e.preventDefault();
                e.stopPropagation();
                closeScienceModal();
            }
        }, true); // Use capture phase

        // --- ENGINE INIT ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0b0c15);
        scene.fog = new THREE.FogExp2(0x0b0c15, 0.0012);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ 
            antialias: false, 
            powerPreference: "high-performance",
            alpha: false,
            stencil: false,
            depth: true,
            preserveDrawingBuffer: false // Better performance, reduces tearing
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2)); // Limit pixel ratio to prevent tearing
        // Reduce shadow map resolution to prevent grey screen on low-end devices
        renderer.shadowMap.enabled = true; 
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputEncoding = THREE.sRGBEncoding;
        // Optimize rendering to reduce tearing
        renderer.sortObjects = false; // Disable sorting for better performance
        // Enable vsync-like behavior
        renderer.setAnimationLoop(null); // Use our own loop for better control
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- LIGHTING ---
        const amb = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(amb);
        const sun = new THREE.DirectionalLight(0xaaccff, 0.8);
        sun.position.set(-50, 100, -50);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 512; sun.shadow.mapSize.height = 512;
        sun.shadow.camera.left = -100; sun.shadow.camera.right = 100;
        sun.shadow.camera.top = 100; sun.shadow.camera.bottom = -100;
        scene.add(sun);

        // --- ASSETS ---
        // Calculate wheel positions based on count and body dimensions
        function calculateWheelPositions(count, bodyLength, bodyWidth) {
            const positions = [];
            const halfLength = bodyLength * 0.4; // Distance from center
            const halfWidth = bodyWidth * 0.5;
            
            if (count === 2) {
                // Two wheels: front and back, centered
                positions.push({x: halfLength, z: 0});
                positions.push({x: -halfLength, z: 0});
            } else if (count === 3) {
                // Three wheels: triangle formation
                positions.push({x: halfLength, z: 0});
                positions.push({x: -halfLength, z: halfWidth * 0.6});
                positions.push({x: -halfLength, z: -halfWidth * 0.6});
            } else if (count === 4) {
                // Four wheels: standard car layout
                positions.push({x: halfLength, z: halfWidth * 0.6});
                positions.push({x: halfLength, z: -halfWidth * 0.6});
                positions.push({x: -halfLength, z: halfWidth * 0.6});
                positions.push({x: -halfLength, z: -halfWidth * 0.6});
            } else {
                // 5+ wheels: distribute evenly
                const rows = Math.ceil(count / 2);
                const spacingX = (bodyLength * 0.8) / (rows - 1);
                const startX = -bodyLength * 0.4;
                
                for (let i = 0; i < count; i++) {
                    const row = Math.floor(i / 2);
                    const side = i % 2 === 0 ? 1 : -1;
                    const x = startX + (row * spacingX);
                    const z = side * halfWidth * 0.6;
                    positions.push({x, z});
                }
            }
            
            return positions;
        }
        
        function createCar(color, isPlayer, design = null) {
            const g = new THREE.Group();
            
            // Default design if not provided
            if (!design) {
                design = {
                    wheelCount: 4,
                    wheelSize: 'medium',
                    bodyLength: 'medium',
                    bodyWidth: 'medium',
                    bodyWeight: 'medium'
                };
            }
            
            // Calculate body dimensions
            const bodyLengthMap = { short: 4, medium: 5, long: 6.5 };
            const bodyWidthMap = { narrow: 1.8, medium: 2.4, wide: 3.2 };
            const bodyLength = bodyLengthMap[design.bodyLength] || 5;
            const bodyWidth = bodyWidthMap[design.bodyWidth] || 2.4;
            
            // Body
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(bodyLength, 0.8, bodyWidth),
                new THREE.MeshStandardMaterial({ color: color, roughness: 0.2, metalness: 0.7 })
            );
            body.position.y = 0.8;
            body.castShadow = true;
            g.add(body);

            // Cockpit
            const cockLength = Math.min(bodyLength * 0.6, 3);
            const cock = new THREE.Mesh(
                new THREE.BoxGeometry(cockLength, 0.6, bodyWidth * 0.75), 
                new THREE.MeshStandardMaterial({color: 0x111, roughness: 0.1})
            );
            cock.position.set(-0.5, 1.4, 0);
            g.add(cock);

            // Wheels - Dynamic generation based on wheelCount
            const wheelSizeMap = { small: 0.6, medium: 0.8, large: 1.0 };
            const wheelRadius = wheelSizeMap[design.wheelSize] || 0.8;
            const wheelWidth = wheelSizeMap[design.wheelSize] * 0.75 || 0.6;
            
            const wGeo = new THREE.CylinderGeometry(wheelRadius, wheelRadius, wheelWidth, 24);
            wGeo.rotateX(Math.PI/2);
            const wMat = new THREE.MeshStandardMaterial({ color: 0x111 });
            const rimMat = new THREE.MeshBasicMaterial({ color: color });
            
            const wheelCount = design.wheelCount || 4;
            const wheelPositions = calculateWheelPositions(wheelCount, bodyLength, bodyWidth);
            
            wheelPositions.forEach(p => {
                const w = new THREE.Mesh(wGeo, wMat);
                w.position.set(p.x, wheelRadius, p.z);
                w.castShadow = true;
                const rim = new THREE.Mesh(
                    new THREE.TorusGeometry(wheelRadius * 0.625, 0.05, 8, 24), 
                    rimMat
                );
                rim.position.z = p.z > 0 ? wheelWidth/2 : -wheelWidth/2;
                w.add(rim);
                w.name = "wheel"; // Mark as wheel for rotation
                g.add(w);
            });
            
            // Store design in group for later reference
            g.userData.design = design;

            if(isPlayer) {
                // Player Marker Arrow
                const arrow = new THREE.Group();
                const cone = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1, 16), new THREE.MeshBasicMaterial({color: 0x00d2ff}));
                cone.rotation.x = Math.PI; // Point down
                cone.position.y = 0;
                arrow.add(cone);
                arrow.position.set(0, 4, 0);
                arrow.name = "marker";
                g.add(arrow);
            }
            return g;
        }

        let pCar = createCar(state.player.color, true, state.player.design); 
        pCar.position.z = 0; 
        scene.add(pCar);
        // AI cars will be created when starting the race
        let ai1Car = null;
        let ai2Car = null;
        let ai3Car = null;
        let ai4Car = null;

        function createTrack() {
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(10000, 10000),
                new THREE.MeshStandardMaterial({ color: 0x080910, roughness: 0.8 })
            );
            floor.rotation.x = -Math.PI/2;
            floor.receiveShadow = true;
            scene.add(floor);

            const road = new THREE.Mesh(
                new THREE.PlaneGeometry(CONFIG.finishLine+600, 100),
                new THREE.MeshStandardMaterial({ color: 0x1a1a20, roughness: 0.5 })
            );
            road.rotation.x = -Math.PI/2;
            road.position.set(CONFIG.finishLine/2, 0.05, 0);
            road.receiveShadow = true;
            scene.add(road);

            const grid = new THREE.GridHelper(CONFIG.finishLine+1000, 200, 0x00d2ff, 0x111122);
            grid.position.set(CONFIG.finishLine/2, 0.1, 0);
            grid.scale.y = 0.8; 
            scene.add(grid);

            const finish = new THREE.Mesh(
                new THREE.PlaneGeometry(2, 100),
                new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide })
            );
            finish.rotation.x = -Math.PI/2;
            finish.position.set(CONFIG.finishLine, 0.15, 0);
            scene.add(finish);

            const geo = new THREE.BoxGeometry(1,1,1);
            const mat = new THREE.MeshPhongMaterial({ color: 0x151525, emissive: 0x050510 });
            for(let i=0; i<40; i++) {
                const b = new THREE.Mesh(geo, mat);
                const h = 20+Math.random()*50;
                b.scale.set(30, h, 30);
                b.position.set(Math.random()*CONFIG.finishLine, h/2, (Math.random()>0.5?1:-1)*(80+Math.random()*40));
                scene.add(b);
            }
        }
        createTrack();

        // --- LOGIC ---
        function updateAI(ai, mesh) {
            if(ai.finished) return;

            // Physics
            ai.x += ai.v;
            if(ai.v > 0) {
                // Use custom physics if available (for compare mode), otherwise use defaults
                const friction = ai.totalFriction || CONFIG.baseFriction;
                const drag = ai.totalDrag || CONFIG.baseDrag;
                ai.v *= friction;
                ai.v -= (ai.v*ai.v)*drag;
                if(ai.v < CONFIG.MIN_VELOCITY) ai.v = 0;
            }
            mesh.position.x = ai.x;
            
            // Wheels rotation - use name check for better performance
            mesh.children.forEach(c => {
                if(c.name === 'wheel') {
                    c.rotation.z -= ai.v * CONFIG.WHEEL_ROTATION_MULT;
                }
            });

            if(ai.x >= CONFIG.finishLine) {
                ai.finished = true;
                state.finishOrder.push(ai);
                checkEndGame();
            }

            const now = Date.now();
            if(ai.status === 'idle' && ai.v < 0.2 && now > ai.nextAction) {
                ai.status = 'charging';
                ai.chargeStart = now;
                // Randomized charge time based on duration
                ai.currentChargeTime = Math.max(200, ai.chargeDuration + (Math.random()*600 - 300));
            } else if(ai.status === 'charging') {
                const prog = Math.min((now - ai.chargeStart)/ai.currentChargeTime, 1);
                
                mesh.rotation.z = prog * 0.2;
                mesh.position.y = 0.8 - (prog*0.2);
                
                if(prog >= 1) {
                    const force = ai.k * ai.targetPull;
                    const mass = ai.totalMass || CONFIG.carMass;
                    ai.v += (force/mass)*0.15;
                    ai.status = 'idle';
                    
                    // Use baseCooldown for consistent difficulty settings
                    const cooldown = ai.baseCooldown || 1000;
                    ai.nextAction = now + cooldown + Math.random()*500;
                    
                    mesh.rotation.z = 0; mesh.position.y = 0.8;
                }
            }
        }

        function updatePlayer() {
            if(state.player.finished) return;

            state.player.x += state.player.v;
            if(state.player.v > 0) {
                // Use calculated physics properties
                state.player.v *= state.player.totalFriction;
                state.player.v -= (state.player.v * state.player.v) * state.player.totalDrag;
                
                if(state.player.v < CONFIG.MIN_VELOCITY || isNaN(state.player.v)) state.player.v = 0;
            }
            pCar.position.x = state.player.x;

            // Wheels rotation - use name check for better performance
            pCar.children.forEach(c => {
                if(c.name === 'wheel') {
                    c.rotation.z -= state.player.v * CONFIG.WHEEL_ROTATION_MULT;
                }
            });

            const mark = pCar.getObjectByName("marker");
            if(mark) {
                mark.position.y = 4 + Math.sin(Date.now()*0.005)*0.5;
                mark.rotation.y += 0.05;
            }

            if(state.player.x >= CONFIG.finishLine) {
                state.player.finished = true;
                state.finishOrder.push(state.player);
                checkEndGame();
            }
        }

        function checkEndGame() {
            const finishedCount = [state.ai1, state.ai2, state.ai3, state.ai4].filter(a => a.finished).length;
            const playerFin = state.player.finished;
            const allAiFin = finishedCount === 4;

            if(playerFin || allAiFin) {
                setTimeout(showResults, 1000);
            }
        }

        function showResults() {
            state.phase = 'finished';
            if(DOM.endScreen) DOM.endScreen.style.display = 'flex';
            if(!DOM.rankList) return;
            
            // Calculate rankings
            const all = [state.player, state.ai1, state.ai2, state.ai3, state.ai4].sort((a,b) => b.x - a.x);
            const playerRank = all.findIndex(c => c.id === 'p1') + 1;
            
            // Show player result card
            const playerResultDiv = document.getElementById('player-result');
            if (playerResultDiv && state.player.x >= CONFIG.finishLine && state.elapsedTime) {
                const minutes = Math.floor(state.elapsedTime / 1000 / 60);
                const seconds = ((state.elapsedTime / 1000) % 60).toFixed(2);
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(5, '0')}`;
                
                let rankText = '';
                let rankEmoji = '';
                if (playerRank === 1) {
                    rankText = 'ğŸ¥‡ ç¬¬ä¸€åï¼';
                    rankEmoji = 'ğŸ†';
                } else if (playerRank === 2) {
                    rankText = 'ğŸ¥ˆ ç¬¬äºŒå';
                    rankEmoji = 'â­';
                } else if (playerRank === 3) {
                    rankText = 'ğŸ¥‰ ç¬¬ä¸‰å';
                    rankEmoji = 'âœ¨';
                } else {
                    rankText = `ç¬¬ ${playerRank} å`;
                }
                
                playerResultDiv.style.display = 'block';
                playerResultDiv.innerHTML = `
                    <div style="font-size: 1.2rem; color: #00d2ff; margin-bottom: 10px;">${state.player.name || 'æœªå‘½å'}</div>
                    <div class="player-result-time">${timeStr}</div>
                    <div class="player-result-rank">${rankText}</div>
                `;
            } else if (playerResultDiv) {
                playerResultDiv.style.display = 'none';
            }
            
            // Show current race rankings
            DOM.rankList.innerHTML = '';
            all.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'rank-row';
                
                let medal = '';
                if (i === 0) medal = 'ğŸ¥‡';
                else if (i === 1) medal = 'ğŸ¥ˆ';
                else if (i === 2) medal = 'ğŸ¥‰';
                
                const name = c.name || c.id;
                div.innerHTML = `
                    <span class="rank-place">${i+1}</span>
                    ${medal ? `<span class="rank-medal">${medal}</span>` : ''}
                    <span class="rank-name" style="${c.id === 'p1' ? 'color: #00d2ff; font-weight: bold;' : ''}">${name}</span>
                `;
                DOM.rankList.appendChild(div);
            });
            
            // Save player's time if they finished
            if (state.player.x >= CONFIG.finishLine && state.elapsedTime) {
                const playerName = state.player.name || 'æœªå‘½å';
                const record = {
                    name: playerName,
                    time: state.elapsedTime / 1000, // Convert to seconds
                    timestamp: Date.now()
                };
                LeaderboardStorage.save(record);
            }
            
            // Update subtitle
            const subtitle = document.getElementById('end-screen-subtitle');
            if (subtitle) {
                if (playerRank === 1) {
                    subtitle.textContent = 'ğŸ‰ æ­å–œç²å¾—ç¬¬ä¸€åï¼';
                    subtitle.style.color = '#ffcc00';
                } else if (playerRank <= 3) {
                    subtitle.textContent = `ğŸ‘ è¡¨ç¾ä¸éŒ¯ï¼ç²å¾—ç¬¬ ${playerRank} å`;
                    subtitle.style.color = '#00d2ff';
                } else {
                    subtitle.textContent = `ç¹¼çºŒåŠªåŠ›ï¼ç²å¾—ç¬¬ ${playerRank} å`;
                    subtitle.style.color = '#8899aa';
                }
            }
            
            // Show leaderboard
            refreshLeaderboard();
        }
        
        function refreshLeaderboard() {
            if(DOM.leaderboardList) {
                DOM.leaderboardList.innerHTML = '';
                const leaderboard = LeaderboardStorage.getAll();
                
                if (leaderboard.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'leaderboard-row';
                    emptyDiv.style.color = '#888';
                    emptyDiv.textContent = 'æš«ç„¡è¨˜éŒ„';
                    DOM.leaderboardList.appendChild(emptyDiv);
                } else {
                    leaderboard.forEach((record, i) => {
                        const div = document.createElement('div');
                        div.className = 'leaderboard-row';
                        const totalSeconds = record.time; // Already in seconds
                        const minutes = Math.floor(totalSeconds / 60);
                        const seconds = (totalSeconds % 60).toFixed(2);
                        const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(5, '0')}`;
                        
                        let rankEmoji = '';
                        if (i === 0) rankEmoji = 'ğŸ¥‡';
                        else if (i === 1) rankEmoji = 'ğŸ¥ˆ';
                        else if (i === 2) rankEmoji = 'ğŸ¥‰';
                        
                        div.innerHTML = `
                            <span class="leaderboard-rank">${i+1}${rankEmoji ? ' ' + rankEmoji : ''}</span>
                            <span class="leaderboard-name">${record.name}</span>
                            <span class="leaderboard-time">${timeStr}</span>
                        `;
                        DOM.leaderboardList.appendChild(div);
                    });
                }
            }
        }
        
        function clearLeaderboard() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ’è¡Œæ¦œè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                LeaderboardStorage.clear();
                refreshLeaderboard();
                alert('æ’è¡Œæ¦œè¨˜éŒ„å·²æ¸…é™¤');
            }
        }
        
        // Make function globally accessible
        window.clearLeaderboard = clearLeaderboard;

        function updateRankings() {
            const all = [state.player, state.ai1, state.ai2, state.ai3, state.ai4].sort((a,b) => b.x - a.x);
            all.forEach((c, i) => {
                const el = document.getElementById(c.id + '-rank');
                if(el) el.innerText = (i+1) + (["st","nd","rd"][((i+1)+90)%100-10]%10-1||"th");
            });
            
            // æ›´æ–°åç¨±é¡¯ç¤ºï¼ˆç¢ºä¿åç¨±å§‹çµ‚æ­£ç¢ºé¡¯ç¤ºï¼‰
            const p1NameEl = document.getElementById('p1-name');
            const ai1NameEl = document.getElementById('ai1-name');
            if (p1NameEl && state.player.name) {
                p1NameEl.textContent = state.player.name;
            }
            if (ai1NameEl && state.ai1.name) {
                ai1NameEl.textContent = state.ai1.name;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if(state.phase === 'racing') {
                // Update timer
                updateTimer();
                
                // Only update game logic if not paused
                if (!state.paused) {
                    updatePlayer();
                    if (ai1Car) updateAI(state.ai1, ai1Car);
                    if (ai2Car) updateAI(state.ai2, ai2Car);
                    if (ai3Car) updateAI(state.ai3, ai3Car);
                    if (ai4Car) updateAI(state.ai4, ai4Car);
                    updateRankings(); // This also updates names
                }

                const speedOffset = Math.min(state.player.v * 3, 30);
                state.camera.target.set(state.player.x - 25 - speedOffset, 12, 15);
                state.camera.look.set(state.player.x + 30, 0, 0);

                if(DOM.speedDisplay) DOM.speedDisplay.innerText = Math.round(state.player.v * CONFIG.SPEED_TO_KMH);
                const max = CONFIG.finishLine;
                const updateBar = (id, x) => {
                    const bar = document.getElementById(id);
                    if(bar) bar.style.width = Math.min(x/max*100, 100)+'%';
                };
                updateBar('p1-bar', state.player.x);
                updateBar('ai1-bar', state.ai1.x);
                updateBar('ai2-bar', state.ai2.x);
                updateBar('ai3-bar', state.ai3.x);
                updateBar('ai4-bar', state.ai4.x);

            } else if (state.phase === 'setup' || state.phase === 'countdown') {
                // Stop camera rotation - keep static view
                if (state.phase === 'setup') {
                    state.camera.target.set(10, 10, 15);
                    state.camera.look.set(0, 0, 0);
                }
            }
            
            // æŒçºŒæ›´æ–°åç¨±é¡¯ç¤ºï¼ˆç¢ºä¿å§‹çµ‚æ­£ç¢ºï¼‰
            if (state.phase === 'countdown' || state.phase === 'racing') {
                const p1NameEl = document.getElementById('p1-name');
                const ai1NameEl = document.getElementById('ai1-name');
                if (p1NameEl) {
                    const name = state.player.name || 'ç©å®¶ (ä½ )';
                    if (p1NameEl.textContent !== name) {
                        p1NameEl.textContent = name;
                    }
                }
                if (ai1NameEl) {
                    const name = state.ai1.name || 'å‹æ•µ';
                    if (ai1NameEl.textContent !== name) {
                        ai1NameEl.textContent = name;
                    }
                }
            }

            camera.position.lerp(state.camera.target, CONFIG.CAMERA_LERP);
            camera.lookAt(state.camera.look);
            renderer.render(scene, camera);
        }

        // --- CONTROLS ---
        function onStart(y) {
            if(state.phase !== 'racing' || state.player.v > 1 || state.player.finished) return;
            state.input.dragging = true;
            state.input.startY = y;
            if(DOM.tensionUI) DOM.tensionUI.style.display = 'block';
        }
        function onMove(y) {
            if(!state.input.dragging) return;
            const delta = Math.max(0, y - state.input.startY);
            const ratio = Math.min(delta / CONFIG.MAX_PULL_DELTA, 1);
            state.input.tension = ratio * state.player.k * CONFIG.maxPull;
            
            if(DOM.tensionText) DOM.tensionText.innerText = Math.round(state.input.tension) + " N";
            pCar.rotation.z = ratio * CONFIG.WHEEL_ROTATION_MULT;
            pCar.position.y = 0.8 - (ratio * CONFIG.WHEEL_ROTATION_MULT);
        }
        function onEnd() {
            if(!state.input.dragging) return;
            state.input.dragging = false;
            if(DOM.tensionUI) DOM.tensionUI.style.display = 'none';
            pCar.rotation.z = 0; pCar.position.y = 0.8;
            
            if(state.input.tension > CONFIG.PULL_THRESHOLD) {
                // Use calculated total mass instead of base mass
                state.player.v += (state.input.tension / state.player.totalMass) * CONFIG.FORCE_MULTIPLIER;
            }
            state.input.tension = 0;
        }

        // --- TOUCH EVENT FIXES ---
        // Only prevent default if we are ACTUALLY Racing. 
        // This allows clicks/scrolls in the Menu/Setup phase.
        
        window.addEventListener('mousedown', e => onStart(e.clientY));
        window.addEventListener('mousemove', e => onMove(e.clientY));
        window.addEventListener('mouseup', onEnd);
        
        window.addEventListener('touchstart', e => { 
            // If in setup or end screen, allow normal touch (for scrolling/clicking)
            if(state.phase !== 'racing') return;
            
            // In game, prevent scrolling and capture input
            if(e.cancelable) e.preventDefault(); 
            onStart(e.touches[0].clientY); 
        }, {passive:false});

        window.addEventListener('touchmove', e => { 
            if(state.phase !== 'racing') return;

            if(e.cancelable) e.preventDefault(); 
            onMove(e.touches[0].clientY); 
        }, {passive:false});
        
        window.addEventListener('touchend', onEnd);


        // --- PHYSICS CALCULATION ---
        function calculateVehiclePhysics(design) {
            // Calculate wheel weight based on size
            const wheelWeightMap = { small: 0.5, medium: 1.0, large: 1.5 };
            const wheelWeight = wheelWeightMap[design.wheelSize] || 1.0;
            
            // Calculate body weight
            const bodyWeightMap = { light: 10, medium: 15, heavy: 20 };
            const bodyWeight = bodyWeightMap[design.bodyWeight] || 15;
            
            // Total mass = base + wheels + body
            const totalMass = CONFIG.carMass + (design.wheelCount * wheelWeight) + bodyWeight;
            
            // Calculate friction multiplier based on wheel count and type
            const wheelFrictionMap = { 
                slick: 0.6, 
                standard: 1.0, 
                offroad: 1.5 
            };
            const wheelFriction = wheelFrictionMap[design.wheelType] || 1.0;
            
            // More wheels = more friction, but with diminishing returns
            // Use square root to balance: 4 wheels = 1.0x, 10 wheels = 1.58x
            const wheelCountFactor = Math.sqrt(design.wheelCount / 4);
            const totalFriction = 1 - ((1 - CONFIG.baseFriction) * wheelFriction * wheelCountFactor);
            
            // Calculate air drag based on body dimensions and aero
            const lengthFactorMap = { short: 0.8, medium: 1.0, long: 1.3 };
            const widthFactorMap = { narrow: 0.8, medium: 1.0, wide: 1.2 };
            const aeroFactorMap = { streamlined: 0.5, stock: 1.0, bulky: 1.5 };
            
            const lengthFactor = lengthFactorMap[design.bodyLength] || 1.0;
            const widthFactor = widthFactorMap[design.bodyWidth] || 1.0;
            const aeroFactor = aeroFactorMap[design.aero] || 1.0;
            
            const totalDrag = CONFIG.baseDrag * lengthFactor * widthFactor * aeroFactor;
            
            return {
                totalMass,
                totalFriction,
                totalDrag,
                wheelCountFactor
            };
        }

        // --- SETUP ---
        function startSequence() {
            const d = document.getElementById('ai-difficulty').value;
            
            // Adjusted Difficulty Settings - MUCH Easier on Easy Mode
            // Only set ai1 config if not in compare mode (compare mode sets it in startComparison)
            if(d==='easy') { 
                // Rival: Very weak pull, long charge time, long cooldown
                if (!compareMode.active || !state.ai1.design) {
                    state.ai1.targetPull=10; state.ai1.k=35; state.ai1.chargeDuration=3000; state.ai1.baseCooldown=2000;
                } else {
                    // In compare mode, use vehicle's k but adjust AI behavior
                    state.ai1.chargeDuration=3000; state.ai1.baseCooldown=2000;
                }
                // Slowpoke: Extremely weak
                state.ai2.targetPull=8;  state.ai2.k=20; state.ai2.chargeDuration=4000; state.ai2.baseCooldown=3000;
                // Speedy: Fast but very weak
                state.ai3.targetPull=10; state.ai3.k=30; state.ai3.chargeDuration=2000; state.ai3.baseCooldown=1500;
                // Tank: Strong but extremely slow
                state.ai4.targetPull=15; state.ai4.k=50; state.ai4.chargeDuration=3500; state.ai4.baseCooldown=2500;
            } else if(d==='medium') { 
                // Standard Settings
                if (!compareMode.active || !state.ai1.design) {
                    state.ai1.targetPull=15; state.ai1.k=55; state.ai1.chargeDuration=1200; state.ai1.baseCooldown=1000;
                } else {
                    state.ai1.chargeDuration=1200; state.ai1.baseCooldown=1000;
                }
                state.ai2.targetPull=10; state.ai2.k=25; state.ai2.chargeDuration=2500; state.ai2.baseCooldown=2000;
                state.ai3.targetPull=12; state.ai3.k=40; state.ai3.chargeDuration=600;  state.ai3.baseCooldown=800;
                state.ai4.targetPull=20; state.ai4.k=70; state.ai4.chargeDuration=2000; state.ai4.baseCooldown=1500;
            } else { 
                // Hard Settings
                if (!compareMode.active || !state.ai1.design) {
                    state.ai1.targetPull=20; state.ai1.k=70; state.ai1.chargeDuration=600;  state.ai1.baseCooldown=500;
                } else {
                    state.ai1.chargeDuration=600; state.ai1.baseCooldown=500;
                }
                state.ai2.targetPull=12; state.ai2.k=35; state.ai2.chargeDuration=2000; state.ai2.baseCooldown=1500;
                state.ai3.targetPull=15; state.ai3.k=50; state.ai3.chargeDuration=400;  state.ai3.baseCooldown=400;
                state.ai4.targetPull=25; state.ai4.k=90; state.ai4.chargeDuration=1500; state.ai4.baseCooldown=1000;
            }

            // Read all design parameters
            state.player.design = {
                wheelType: document.getElementById('wheel-select').value,
                wheelCount: parseInt(document.getElementById('wheel-count-range').value),
                wheelSize: document.getElementById('wheel-size-select').value,
                bodyLength: document.getElementById('body-length-select').value,
                bodyWidth: document.getElementById('body-width-select').value,
                bodyWeight: document.getElementById('body-weight-select').value,
                aero: document.getElementById('aero-select').value,
                material: document.getElementById('material-select').value,
                thickness: parseFloat(document.getElementById('thickness-range').value),
                length: parseFloat(document.getElementById('length-range').value)
            };
            
            // Calculate physics properties
            const physics = calculateVehiclePhysics(state.player.design);
            state.player.totalMass = physics.totalMass;
            state.player.totalFriction = physics.totalFriction;
            state.player.totalDrag = physics.totalDrag;
            
            // Calculate spring constant
            const mat = parseFloat(state.player.design.material);
            state.player.k = Math.min(200, (mat * state.player.design.thickness * 5) / (state.player.design.length/5));
            
            // Recreate player car with new design
            const oldX = pCar.position.x;
            const oldY = pCar.position.y;
            const oldZ = pCar.position.z;
            scene.remove(pCar);
            pCar = createCar(state.player.color, true, state.player.design);
            pCar.position.set(oldX, oldY, oldZ);
            scene.add(pCar);
            
            // Create AI cars for the race
            if (!ai1Car) {
                ai1Car = createCar(state.ai1.color, false);
                ai1Car.position.set(0, 0, -6);
                scene.add(ai1Car);
            }
            if (!ai2Car) {
                ai2Car = createCar(state.ai2.color, false);
                ai2Car.position.set(0, 0, -12);
                scene.add(ai2Car);
            }
            if (!ai3Car) {
                ai3Car = createCar(state.ai3.color, false);
                ai3Car.position.set(0, 0, 6);
                scene.add(ai3Car);
            }
            if (!ai4Car) {
                ai4Car = createCar(state.ai4.color, false);
                ai4Car.position.set(0, 0, 12);
                scene.add(ai4Car);
            }

            if(DOM.garage) DOM.garage.classList.add('hidden');
            if(DOM.hud) DOM.hud.style.display = 'block';
            
            // æ›´æ–°HUDä¸­çš„åç¨±é¡¯ç¤ºï¼ˆå¦‚æœä¸æ˜¯æ¯”è¼ƒæ¨¡å¼ï¼Œä½¿ç”¨å·²è¨­å®šçš„åç¨±ï¼‰
            if (!compareMode.active) {
                // å¦‚æœæ²’æœ‰è¨­å®šåç¨±ï¼Œä½¿ç”¨é»˜èªåç¨±
                if (!state.player.name || state.player.name === 'ç©å®¶ (ä½ )') {
                    state.player.name = 'æœªå‘½å';
                }
                state.ai1.name = 'å‹æ•µ';
                const p1NameEl = document.getElementById('p1-name');
                const ai1NameEl = document.getElementById('ai1-name');
                if (p1NameEl) p1NameEl.textContent = state.player.name;
                if (ai1NameEl) ai1NameEl.textContent = 'å‹æ•µ';
            }
            
            state.phase = 'countdown';
            
            // ç«‹å³æ›´æ–°åç¨±é¡¯ç¤ºï¼ˆåœ¨countdowné–‹å§‹æ™‚ï¼‰
            const p1NameEl = document.getElementById('p1-name');
            const ai1NameEl = document.getElementById('ai1-name');
            if (p1NameEl) {
                p1NameEl.textContent = state.player.name || 'ç©å®¶ (ä½ )';
            }
            if (ai1NameEl) {
                ai1NameEl.textContent = state.ai1.name || 'å‹æ•µ';
            }
            
            if(DOM.countdown) {
                DOM.countdown.style.display = 'block';
                let c = 3;
                const t = setInterval(() => {
                    DOM.countdown.innerText = c;
                    c--;
                    if(c < 0) {
                        clearInterval(t);
                        DOM.countdown.innerText = "GO!";
                        state.phase = 'racing';
                        state.raceStartTime = Date.now();
                        state.elapsedTime = 0;
                        state.paused = false;
                        
                        // Show pause button and timer
                        const pauseBtn = document.getElementById('pause-btn');
                        const timer = document.getElementById('timer');
                        if (pauseBtn) pauseBtn.style.display = 'block';
                        if (timer) timer.style.display = 'block';
                        
                        // ç¢ºä¿åç¨±é¡¯ç¤ºæ­£ç¢º
                        const p1NameEl = document.getElementById('p1-name');
                        const ai1NameEl = document.getElementById('ai1-name');
                        if (p1NameEl && state.player.name) {
                            p1NameEl.textContent = state.player.name;
                        }
                        if (ai1NameEl && state.ai1.name) {
                            ai1NameEl.textContent = state.ai1.name;
                        }
                        
                        setTimeout(() => DOM.countdown.style.display='none', 1000);
                    }
                }, 1000);
            }
        }

        // --- PAUSE FUNCTIONALITY ---
        function pauseGame() {
            if (state.phase !== 'racing' || state.paused) return;
            state.paused = true;
            state.pauseStartTime = Date.now();
            const pauseMenu = document.getElementById('pause-menu');
            if (pauseMenu) pauseMenu.style.display = 'flex';
        }

        function resumeGame() {
            if (!state.paused) return;
            state.paused = false;
            // Adjust elapsed time to account for pause duration
            const pauseDuration = Date.now() - state.pauseStartTime;
            state.raceStartTime += pauseDuration;
            const pauseMenu = document.getElementById('pause-menu');
            if (pauseMenu) pauseMenu.style.display = 'none';
        }

        function restartGame() {
            // Reset all positions and states
            state.player.x = 0;
            state.player.v = 0;
            state.player.finished = false;
            
            state.ai1.x = 0;
            state.ai1.v = 0;
            state.ai1.finished = false;
            state.ai1.status = 'idle';
            state.ai1.nextAction = 0;
            
            state.ai2.x = 0;
            state.ai2.v = 0;
            state.ai2.finished = false;
            state.ai2.status = 'idle';
            state.ai2.nextAction = 0;
            
            state.ai3.x = 0;
            state.ai3.v = 0;
            state.ai3.finished = false;
            state.ai3.status = 'idle';
            state.ai3.nextAction = 0;
            
            state.ai4.x = 0;
            state.ai4.v = 0;
            state.ai4.finished = false;
            state.ai4.status = 'idle';
            state.ai4.nextAction = 0;
            
            state.finishOrder = [];
            state.paused = false;
            
            // Reset car positions
            if (pCar) {
                pCar.position.set(0, 0, 0);
                pCar.rotation.z = 0;
                pCar.position.y = 0.8;
            }
            
            // Create AI cars if they don't exist
            if (!ai1Car) {
                ai1Car = createCar(state.ai1.color, false);
                ai1Car.position.set(0, 0, -6);
                scene.add(ai1Car);
            } else {
                ai1Car.position.set(0, 0, -6);
                ai1Car.rotation.z = 0;
                ai1Car.position.y = 0.8;
            }
            
            if (!ai2Car) {
                ai2Car = createCar(state.ai2.color, false);
                ai2Car.position.set(0, 0, -12);
                scene.add(ai2Car);
            } else {
                ai2Car.position.set(0, 0, -12);
                ai2Car.rotation.z = 0;
                ai2Car.position.y = 0.8;
            }
            
            if (!ai3Car) {
                ai3Car = createCar(state.ai3.color, false);
                ai3Car.position.set(0, 0, 6);
                scene.add(ai3Car);
            } else {
                ai3Car.position.set(0, 0, 6);
                ai3Car.rotation.z = 0;
                ai3Car.position.y = 0.8;
            }
            
            if (!ai4Car) {
                ai4Car = createCar(state.ai4.color, false);
                ai4Car.position.set(0, 0, 12);
                scene.add(ai4Car);
            } else {
                ai4Car.position.set(0, 0, 12);
                ai4Car.rotation.z = 0;
                ai4Car.position.y = 0.8;
            }
            
            // Close pause menu
            const pauseMenu = document.getElementById('pause-menu');
            if (pauseMenu) pauseMenu.style.display = 'none';
            
            // Hide pause button and timer temporarily
            const pauseBtn = document.getElementById('pause-btn');
            const timer = document.getElementById('timer');
            if (pauseBtn) pauseBtn.style.display = 'none';
            if (timer) timer.style.display = 'none';
            
            // Restart countdown
            state.phase = 'countdown';
            const DOM = {
                countdown: document.getElementById('countdown')
            };
            
            if(DOM.countdown) {
                DOM.countdown.style.display = 'block';
                let c = 3;
                const t = setInterval(() => {
                    DOM.countdown.innerText = c;
                    c--;
                    if(c < 0) {
                        clearInterval(t);
                        DOM.countdown.innerText = "GO!";
                        state.phase = 'racing';
                        state.raceStartTime = Date.now();
                        state.elapsedTime = 0;
                        state.paused = false;
                        
                        // Show pause button and timer
                        if (pauseBtn) pauseBtn.style.display = 'block';
                        if (timer) timer.style.display = 'block';
                        
                        // ç¢ºä¿åç¨±é¡¯ç¤ºæ­£ç¢º
                        const p1NameEl = document.getElementById('p1-name');
                        const ai1NameEl = document.getElementById('ai1-name');
                        if (p1NameEl && state.player.name) {
                            p1NameEl.textContent = state.player.name;
                        }
                        if (ai1NameEl && state.ai1.name) {
                            ai1NameEl.textContent = state.ai1.name;
                        }
                        
                        setTimeout(() => DOM.countdown.style.display='none', 1000);
                    }
                }, 1000);
            }
        }

        function returnToMainMenu() {
            // Reset game state
            state.phase = 'menu';
            state.paused = false;
            state.player.x = 0;
            state.player.v = 0;
            state.player.finished = false;
            state.player.name = ''; // Reset name so user needs to input again
            state.ai1.x = 0;
            state.ai1.v = 0;
            state.ai1.finished = false;
            state.ai2.x = 0;
            state.ai2.v = 0;
            state.ai2.finished = false;
            state.ai3.x = 0;
            state.ai3.v = 0;
            state.ai3.finished = false;
            state.ai4.x = 0;
            state.ai4.v = 0;
            state.ai4.finished = false;
            
            // Remove AI cars from scene
            if (ai1Car && scene.children.includes(ai1Car)) {
                scene.remove(ai1Car);
                ai1Car = null;
            }
            if (ai2Car && scene.children.includes(ai2Car)) {
                scene.remove(ai2Car);
                ai2Car = null;
            }
            if (ai3Car && scene.children.includes(ai3Car)) {
                scene.remove(ai3Car);
                ai3Car = null;
            }
            if (ai4Car && scene.children.includes(ai4Car)) {
                scene.remove(ai4Car);
                ai4Car = null;
            }
            
            // Hide all UI elements
            if(DOM.hud) DOM.hud.style.display = 'none';
            if(DOM.endScreen) DOM.endScreen.style.display = 'none';
            if(DOM.countdown) DOM.countdown.style.display = 'none';
            if(DOM.garage) {
                DOM.garage.style.display = 'none';
                DOM.garage.classList.add('hidden');
            }
            
            // Show main menu
            showMainMenu();
        }

        // --- TIMER FUNCTIONALITY ---
        function updateTimer() {
            if (state.phase !== 'racing' || state.paused) return;
            
            const now = Date.now();
            state.elapsedTime = now - state.raceStartTime;
            
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                const seconds = Math.floor(state.elapsedTime / 1000);
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
        }

        // Make functions globally accessible
        window.pauseGame = pauseGame;
        window.resumeGame = resumeGame;
        window.restartGame = restartGame;
        window.returnToMainMenu = returnToMainMenu;
        
        // Bind pause button
        setTimeout(() => {
            const pauseBtn = document.getElementById('pause-btn');
            if (pauseBtn) {
                pauseBtn.addEventListener('click', pauseGame);
            }
            
            const resumeBtn = document.getElementById('resume-btn');
            const restartBtn = document.getElementById('restart-btn');
            const mainMenuBtn = document.getElementById('main-menu-btn');
            
            if (resumeBtn) {
                resumeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    resumeGame();
                });
            }
            
            if (restartBtn) {
                restartBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    restartGame();
                });
            }
            
            if (mainMenuBtn) {
                mainMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    returnToMainMenu();
                });
            }
        }, 0);

        function updateStats() {
            const mat = parseFloat(document.getElementById('material-select').value);
            const thk = parseFloat(document.getElementById('thickness-range').value);
            const len = parseFloat(document.getElementById('length-range').value);
            const k = (mat * thk * 5) / (len/5);
            if(DOM.kValue) DOM.kValue.innerText = k.toFixed(1);
            if(DOM.eValue) DOM.eValue.innerText = Math.round(0.5*k*225) + " J";
        }
        // Initialize tooltips and science principle modals
        document.querySelectorAll('.info-icon').forEach(icon => {
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                const group = icon.closest('.control-group');
                if (group) {
                    // Find the input/select element in this group
                    const input = group.querySelector('input, select');
                    if (input && input.id) {
                        // Show science principle modal
                        showSciencePrinciple(input.id);
                    } else {
                        // Fallback to tooltip toggle
                        group.classList.toggle('active');
                    }
                }
            });
        });
        // Close tooltips when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.control-group') && !e.target.closest('#science-modal')) {
                document.querySelectorAll('.control-group.active').forEach(g => g.classList.remove('active'));
            }
        });
        
        // Auto-show science principle when clicking/focusing on options (first time only)
        const shownPrinciples = new Set();
        
        // Function to update main scene vehicle
        function updateMainVehicle() {
            if (state.phase !== 'setup') return; // Only update during setup phase
            
            // Get current design
            const design = {
                wheelType: document.getElementById('wheel-select')?.value || 'standard',
                wheelCount: parseInt(document.getElementById('wheel-count-range')?.value || 4),
                wheelSize: document.getElementById('wheel-size-select')?.value || 'medium',
                bodyLength: document.getElementById('body-length-select')?.value || 'medium',
                bodyWidth: document.getElementById('body-width-select')?.value || 'medium',
                bodyWeight: document.getElementById('body-weight-select')?.value || 'medium'
            };
            
            // Remove old player car
            if (pCar) {
                scene.remove(pCar);
            }
            
            // Create new player car with updated design
            pCar = createCar(state.player.color, true, design);
            pCar.position.set(0, 0, 0);
            scene.add(pCar);
        }
        
        document.querySelectorAll('select, input[type="range"]').forEach(el => {
            // Show science principle on focus/click (first time only)
            el.addEventListener('focus', () => {
                if (el.id && sciencePrinciples[el.id] && !shownPrinciples.has(el.id)) {
                    shownPrinciples.add(el.id);
                    setTimeout(() => {
                        showSciencePrinciple(el.id);
                    }, 100);
                }
            });
            
            // Update main vehicle on change
            el.addEventListener('change', () => {
                updateMainVehicle();
            });
        });

        // Update wheel count display
        const wheelCountRange = document.getElementById('wheel-count-range');
        const wheelCountDisplay = document.getElementById('wheel-count-display');
        if(wheelCountRange && wheelCountDisplay) {
            wheelCountRange.addEventListener('input', (e) => {
                wheelCountDisplay.innerText = e.target.value + ' å€‹è¼ªå­';
                // Update main vehicle on input (for real-time feedback)
                updateMainVehicle();
            });
        }

        // Update stats and main vehicle on any input (except thickness and length)
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', () => {
                updateStats();
                // Don't update vehicle for thickness and length ranges (only update on change)
                if (el.id !== 'thickness-range' && el.id !== 'length-range') {
                    updateMainVehicle();
                }
            });
            
            // For thickness and length, only update on change (not on input)
            if (el.id === 'thickness-range' || el.id === 'length-range') {
                el.addEventListener('change', () => {
                    updateStats();
                    updateMainVehicle();
                });
            }
        });
        updateStats();
        updateMainVehicle();

        // Initialize DOM cache
        initDOMCache();
        
        // Main menu handlers
        function showMainMenu() {
            const mainMenu = document.getElementById('main-menu');
            const garage = document.getElementById('garage');
            const endScreen = document.getElementById('end-screen');
            if (mainMenu) mainMenu.style.display = 'flex';
            if (garage) garage.style.display = 'none';
            if (endScreen) endScreen.style.display = 'none';
            state.phase = 'menu';
        }
        
        function showCreateNameModal() {
            const modal = document.getElementById('create-name-modal');
            if (modal) modal.style.display = 'flex';
            const input = document.getElementById('create-vehicle-name-input');
            if (input) {
                input.value = '';
                setTimeout(() => input.focus(), 100);
            }
        }
        
        function closeCreateNameModal() {
            const modal = document.getElementById('create-name-modal');
            if (modal) modal.style.display = 'none';
        }
        
        function confirmCreateVehicle() {
            const input = document.getElementById('create-vehicle-name-input');
            const name = input ? input.value.trim() : '';
            if (!name) {
                alert('è«‹è¼¸å…¥è»Šè¼›åç¨±ï¼');
                return;
            }
            state.player.name = name;
            closeCreateNameModal();
            showGarage();
        }
        
        function showGarage() {
            const mainMenu = document.getElementById('main-menu');
            const garage = document.getElementById('garage');
            const endScreen = document.getElementById('end-screen');
            
            // Hide other UI elements
            if (mainMenu) mainMenu.style.display = 'none';
            if (endScreen) endScreen.style.display = 'none';
            
            // Show garage and remove hidden class
            if (garage) {
                garage.style.display = 'block';
                garage.classList.remove('hidden');
            }
            
            state.phase = 'setup';
            
            // Remove AI cars from scene during setup
            if (ai1Car && scene.children.includes(ai1Car)) {
                scene.remove(ai1Car);
            }
            if (ai2Car && scene.children.includes(ai2Car)) {
                scene.remove(ai2Car);
            }
            if (ai3Car && scene.children.includes(ai3Car)) {
                scene.remove(ai3Car);
            }
            if (ai4Car && scene.children.includes(ai4Car)) {
                scene.remove(ai4Car);
            }
            
            // Reset camera position for setup phase
            camera.position.set(10, 10, 15);
            camera.lookAt(0, 0, 0);
            
            // Reset car position if it exists
            if (pCar) {
                pCar.position.set(0, 0, 0);
            }
            
            // Update main vehicle to reflect current settings (this will create/update the car)
            updateMainVehicle();
        }
        
        function showSelectVehicle() {
            openVehicleLibrary();
        }
        
        // Bind main menu buttons
        document.getElementById('create-vehicle-btn')?.addEventListener('click', showCreateNameModal);
        document.getElementById('select-vehicle-btn')?.addEventListener('click', showSelectVehicle);
        document.getElementById('confirm-create-btn')?.addEventListener('click', confirmCreateVehicle);
        document.getElementById('cancel-create-btn')?.addEventListener('click', closeCreateNameModal);
        
        // Make functions globally accessible
        window.showMainMenu = showMainMenu;
        window.closeCreateNameModal = closeCreateNameModal;
        window.confirmCreateVehicle = confirmCreateVehicle;
        
        // Show main menu on load
        showMainMenu();

        camera.position.set(10,10,15);
        animate();
        
        // Window Resize Handling (Mobile Rotate)
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>